<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GamesPlanet - Patched Order Tool</title>
  <style>
    body{font-family:Arial, Helvetica, sans-serif; max-width:980px; margin:20px auto; padding:16px;}
    textarea{width:100%; height:260px; font-size:14px; padding:10px; border-radius:6px;}
    pre{background:#f7f8fb;padding:12px;border-radius:8px;border:1px solid #e6e9ef; white-space:pre-wrap;}
    button{padding:8px 12px;margin:6px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    .hr{height:1px;background:#e6e6e6;margin:12px 0;}
  </style>
</head>
<body>

<h2>GamesPlanet — Patched Order Converter</h2>
<textarea id="input" placeholder="Paste raw order text here..."></textarea>

<div class="row">
  <button onclick="selectAll()">Select All</button>
  <button onclick="clearText()">Clear</button>
  <button onclick="convert()">Convert (Preview)</button>
  <button onclick="copyAll()">Copy Output</button>
</div>

<div class="row">
  <button onclick="sendPrepaidToCustomer()">Send Prepaid → Customer</button>
  <button onclick="sendPrepaidToOwn()">Send Prepaid → Own</button>
  <button onclick="sendCodToCustomer()">Send COD → Customer</button>
  <button onclick="sendCodToOwn()">Send COD → Own</button>
</div>

<div class="row">
  <button onclick="sendThanks()">Send Thanks</button>
  <button onclick="sendAbandonedCart()">Send Abandoned Cart (customer + sales)</button>
  <button onclick="quickBuyToSales()">Quick Buy → Sales (QR)</button>
</div>

<div class="hr"></div>
<pre id="output"></pre>

<script>
/* ------------------ utilities & data ------------------ */
let pincodeLatLng = {};
fetch('pincode_data.json').then(r=>r.json()).then(d=>pincodeLatLng=d).catch(e=>console.log('pincode load err',e));

const products = ["m88","fmcb","ps2","gamestick","gamebox","sd card","sdcard","usb","pendrive","500gb"];
const variants = ["64gb","128gb","256gb","500gb","1tb"];

// small helpers
function selectAll(){ const t=document.getElementById('input'); t.focus(); t.select(); }
function clearText(){ document.getElementById('input').value=''; document.getElementById('output').textContent=''; }
function copyAll(){ navigator.clipboard.writeText(document.getElementById('output').textContent).then(()=>alert('Copied!')).catch(()=>alert('Copy failed')); }
function encodeForWA(t){ return encodeURIComponent(t); }
function waOpen(number, msg){ window.open(`https://wa.me/${number}?text=${encodeForWA(msg)}`, '_blank'); }
function getOwnNumber(){ return '917983624797'; } // default own/sales number
function getCustomerMobile() {
  const raw = document.getElementById('input').value;
  const m = raw.match(/(?:mobile|phone)\\s*[:\\n]\\s*([+]?91[-\\s]?\\d{10}|\\d{10})/i)?.[1];
  if (m) return m.replace(/\\D/g,'').replace(/^0+/, '');
  const any = raw.match(/(?:\\+?91[-\\s]?)?\\d{10}/);
  return any ? any[0].replace(/\\D/g,'').replace(/^0+/, '') : '';
}

/* haversine distance */
function haversine(lat1, lon1, lat2, lon2) {
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function estimateDeliveryByDistance(distance){
  const d = Number(distance);
  if(isNaN(d)) return 'N/A';
  if(d<=30) return '1 day';
  if(d<=60) return '1-2 days';
  if(d<=100) return '2-3 days';
  if(d<=200) return '3-4 days';
  if(d<=500) return '4-5 days';
  if(d<=1000) return '4-6 days';
  if(d<=1500) return '5–7 days';
  if(d<=2000) return '6–8 days';
  if(d<=3000) return '6–10 days';
  return '8–12 days';
}
function parseEtaRange(etaStr){ if(!etaStr||etaStr==='N/A') return null; const nums=(etaStr.match(/\\d+/g)||[]).map(Number); if(nums.length===1) return {min:nums[0],max:nums[0]}; if(nums.length>=2) return {min:nums[0],max:nums[1]}; return null; }
function bumpEtaRangeString(etaStr, addMin=2, addMax=3){ const r=parseEtaRange(etaStr); if(!r) return etaStr; const min=r.min+addMin; const max=r.max+addMax; return (min===max)?`${min} days`:`${min}-${max} days`; }
function todayStrOffset(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'}); }
function estimatedWindowFromEta(etaStr){ const r=parseEtaRange(etaStr); if(!r) return etaStr||''; const s=todayStrOffset(r.min), e=todayStrOffset(r.max); return (r.min===r.max)?s:`${s} to ${e}`; }

/* ------------------ COD & Discount rules ------------------ */
/* COD charges: base >0 && <1499 => 99 ; else 0 */
function computeCodCharges(basePrice){ basePrice = Number(basePrice)||0; if(basePrice>0 && basePrice<1499) return 99; return 0; }

/* compute cod amounts, with M88 special COD base=7499 */
function computeCodAmountsForProduct(d){
  let base = Number(d.basePrice)||0;
  const prod = (d.detectedProduct||'').toLowerCase();
  if(prod.includes('m88')) base = 7499;
  const codCharges = computeCodCharges(base);
  const advance = Math.max(500, Math.round(base * 0.10)); // min 500 or 10%
  const rest = Math.max(0, (base + codCharges) - advance);
  return { advance, rest, codCharges, codBase: base };
}

/* prepaid discount rules (applied only when paymentMethod === 'wa_qr') */
/* M88 -> final prepaid 6699 (discount = base - 6699)
   FMCB/PS2 + usb/pendrive/pd/ssd/combo/500gb => 5% of base
   gamestick/sdcard => fixed: 64->200, 128->300, 256->500
*/
function computePrepaidDiscount(d, paymentMethod){
  const base = Number(d.basePrice)||0;
  if(!base || base<=0) return 0;
  if(paymentMethod !== 'wa_qr') return 0;

  const prod = (d.detectedProduct||'').toLowerCase();
  const variant = (d.variant||'').toLowerCase();
  const notes = ((d.notes||'') + ' ' + (d.extra||'')).toLowerCase();
  const containsAny = (s, arr) => arr.some(tok => s.indexOf(tok)!==-1);

  // M88 special prepaid final price 6699
  if(prod.includes('m88')){
    return Math.max(0, base - 6699);
  }

  // FMCB / PS2 + usb/hdd/pd/ssd/combo/pendrive/500gb => 5%
  if( (prod.includes('fmcb') || prod.includes('ps2')) &&
      containsAny(variant+' '+notes, ['usb','hdd','pd','ssd','combo','pendrive','500gb']) ){
    return Math.round(base * 0.05);
  }

  // gamestick / sd card size based
  if( containsAny(prod, ['gamestick','game stick','gamebox','sd card','sdcard','sd-card']) || containsAny(variant, ['64','128','256']) ){
    if(variant.includes('64') || prod.includes('64gb')) return 200;
    if(variant.includes('128') || prod.includes('128gb')) return 300;
    if(variant.includes('256') || prod.includes('256gb')) return 500;
    return 0;
  }

  return 0;
}

/* ------------------ Parser (robust) ------------------ */
function parseInput(){
  const raw = document.getElementById('input').value || '';
  const lower = raw.toLowerCase();

  // order id
  let orderId = raw.match(/#\s*\d{5,}/)?.[0] || '';
  if(!orderId){
    const fl = raw.split('\n').map(s=>s.trim()).find(s=>s);
    const m = fl && fl.match(/\d{6,}/);
    if(m) orderId = '#'+m[0];
  }
  if(!orderId) orderId = 'Not found';

  // name / mobile / alt / email
  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\n([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\nMobile/i)?.[1] || 'Customer').trim();
  const mobile = (raw.match(/mobile\s*[:\n]\s*([+\d\-\s]{6,})/i)?.[1] || raw.match(/(?:\+?91[-\s]?)?\d{10}/)?.[0] || '').trim();
  const altMobile = (raw.match(/alt(?:ernate)?\s*mobile\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  const email = (raw.match(/email\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)?.[0] || '').trim();

  // address
  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:Payments|Payment|Additional|Customer|Mobile|Email|$))/i)?.[1] ||
                   raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim().replace(/\s+/g,' ');

  let landmark = (raw.match(/landmark\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  if(!landmark){
    const near = address && address.match(/\b(?:near|opp(?:osite)?|behind|beside)\b[^,;|]+/i);
    if(near) landmark = near[0].trim();
  }

  const postOffice = (raw.match(/post\s*office\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || '').trim();

  const basePrice = ((raw.match(/1x\s*₹?\s*([\d,]+)/i)?.[1] || raw.match(/base\s*price\s*[:₹\s]*([\d,]+)/i)?.[1] || '0').replace(/,/g,'')).trim();
  let discount = '0';
  const couponLine = raw.match(/coupon\s*discount.*?(-₹\s*[\d,]+)/i);
  if(couponLine) discount = couponLine[1].replace(/[^\d]/g,'');
  else {
    const d2 = raw.match(/discount\s*applied\s*[:₹\s-]*([\d,]+)/i);
    if(d2) discount = d2[1].replace(/,/g,'');
  }
  const amountPaid = ((raw.match(/total\s*paid\s*[:₹\s]*([\d,]+)/i)?.[1] ||
                      raw.match(/\bpaid\b\s*[:₹\s]*([\d,]+)/i)?.[1] ||
                      raw.match(/amount\s*paid\s*[:₹\s]*([\d,]+)/i)?.[1] || '0').replace(/,/g,'')).trim();

  // detect product
  let detectedProduct = 'Unknown Product';
  const afterItem = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItem && afterItem.length>2) detectedProduct = afterItem.trim();
  if(detectedProduct==='Unknown Product'){
    for(const p of products.sort((a,b)=>b.length-a.length)){
      if(lower.includes(p)) { detectedProduct = p; break; }
    }
  }

  // variant
  let variant = '';
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim();
  else {
    const vInName = detectedProduct.match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1].toUpperCase();
  }

  let city='Unknown', state='Unknown', distance='N/A', eta='N/A';
  if(pincode && pincodeLatLng[pincode]){
    const dest = pincodeLatLng[pincode];
    city = dest.city || 'Unknown'; state = dest.state||'Unknown';
    distance = haversine(28.8,79.0, dest.lat, dest.lng).toFixed(0);
    eta = estimateDeliveryByDistance(distance);
  }

  return {
    orderId, name, mobile, altMobile, email,
    address, landmark, postOffice, pincode,
    basePrice, discount, amountPaid,
    detectedProduct, variant,
    city, state, distance, eta
  };
}

/* ------------------ Message builders (patched) ------------------ */
function buildPrepaidMessage(d){
  const estWindow = d.eta && d.eta!=='N/A' ? estimatedWindowFromEta(d.eta) : '';
  // force prepaid discount rules (wa_qr) as user required for final amount calculation
  const paymentMethod = 'wa_qr';
  const prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - prepaidDiscount);
  d._computed = d._computed || {};
  d._computed.prepaidDiscount = prepaidDiscount;
  d._computed.prepaidAmount = prepaidAmount;

  return `🟢 Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ₹${d.basePrice}
Discount Applied: ₹${d._computed.prepaidDiscount}
Amount Paid: ₹${d._computed.prepaidAmount}

📏 Distance: ${d.distance} km
⏳ Prepaid Order ETA: ${d.eta}
📅 Estimated Delivery: ${estWindow}`;
}

function buildCodMessage(d){
  const codInfo = computeCodAmountsForProduct(d);
  d._computed = d._computed || {};
  d._computed.codCharges = codInfo.codCharges;
  d._computed.codAdvance = codInfo.advance;
  d._computed.codRestOnDelivery = codInfo.rest;
  d._computed.codBase = codInfo.codBase;

  const codEta = d.eta && d.eta!=='N/A' ? bumpEtaRangeString(d.eta,2,3) : d.eta;
  const estCodWindow = codEta && codEta!=='N/A' ? estimatedWindowFromEta(codEta) : '';

  return `🔴 COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ₹${d._computed.codBase}
COD Charges: ₹${d._computed.codCharges}
Amount Paid (Advance): ₹${d._computed.codAdvance}
Rest on Delivery: ₹${d._computed.codRestOnDelivery}

📏 Distance: ${d.distance} km
⏳ COD Order ETA: ${codEta}
📅 Estimated Delivery: ${estCodWindow}`;
}

/* Abandoned cart detailed message (to customer) */
function buildAbandonedCartCustomerMsg(d){
  d._computed = d._computed || {};
  // ensure computed values exist
  const paymentMethod = 'wa_qr';
  d._computed.prepaidDiscount = computePrepaidDiscount(d,paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - d._computed.prepaidDiscount);
  const codInfo = computeCodAmountsForProduct(d);

  const codEta = d.eta && d.eta!=='N/A' ? bumpEtaRangeString(d.eta,2,3) : d.eta;

  return `🌟 GamesPlanet

🙏 Hello ${d.name} ji,

📝 Incomplete Order Details: 
– Order ID: ${d.orderId}
– Product: ${d.detectedProduct} (${d.variant})
– Base Price: ₹${d.basePrice}
📍 City: ${d.city}
📏 Distance: ${d.distance} km

💰 Prepaid Offer: ₹${d.basePrice} – ₹${d._computed.prepaidDiscount} discount = ₹${prepaidAmount}
🚚 Estimated Delivery:
– Prepaid: ${d.eta}

💵 COD: ₹${codInfo.codBase} + COD Charges: ₹${codInfo.codCharges}
➡ COD Advance: ₹${codInfo.advance}
➡ Remaining on Delivery: ₹${codInfo.rest}
🚚 Estimated Delivery:
– COD: ${codEta}

👉 Complete payment soon to confirm your order.

💚 Team GamesPlanet`;
}

/* quick-buy message exact format required by you (to sales number) */
function buildQuickBuyMsg(d){
  // force prepaid discount rules
  const paymentMethod = 'wa_qr';
  const prepaidDiscount = computePrepaidDiscount(d,paymentMethod);
  const finalPrepaidAmount = Math.max(0, Number(d.basePrice||0) - prepaidDiscount);
  const productPart = (d.detectedProduct||'product').toString().trim().toLowerCase();
  const variantPart = (d.variant||'').toString().trim().toLowerCase();
  const variantText = variantPart ? (' ' + variantPart) : '';
  const amountText = String(Math.round(finalPrepaidAmount));
  return `i want to buy ${productPart}${variantText} with discount on full pay ${amountText} please share qr code`;
}

/* ------------------ actions / UI ------------------ */
function convert(){
  const d = parseInput();
  const prepaid = buildPrepaidMessage(d);
  const cod = buildCodMessage(d);
  document.getElementById('output').textContent = prepaid + "\\n\\n" + cod;
}

function sendPrepaidToCustomer(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith('91')?mobile:('91'+mobile), msg);
  else alert('Customer mobile not found');
}
function sendPrepaidToOwn(){ const d=parseInput(); waOpen(getOwnNumber(), buildPrepaidMessage(d)); }
function sendCodToCustomer(){ const d=parseInput(); waOpen(getCustomerMobile().startsWith('91')?getCustomerMobile():('91'+getCustomerMobile()), buildCodMessage(d)); }
function sendCodToOwn(){ const d=parseInput(); waOpen(getOwnNumber(), buildCodMessage(d)); }

function sendThanks(){
  const d = parseInput();
  const msg = `🌟 GamesPlanet
🙏 Hello ${d.name} ji, thank you for your order ${d.orderId}.
📦 Product: ${d.detectedProduct} (${d.variant})
📍 Pincode: ${d.pincode} | 📏 Distance: ${d.distance} km
⏳ Estimated Delivery: ${d.eta}
🚚 Your order will be shipped soon between 8PM–10PM.
🔗 Tracking will update on our website after dispatch.
🖼️ On request, we can send *parcel pic & tracking number* here on WhatsApp.
💚 Team GamesPlanet`;
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith('91')?mobile:('91'+mobile), msg);
  else alert('Customer mobile not found');
}

/* send Abandoned Cart: 1) send detailed msg to customer (if found), 2) open quick-buy msg to sales number */
function sendAbandonedCart(){
  const d = parseInput();
  const custMobile = getCustomerMobile();
  const custMsg = buildAbandonedCartCustomerMsg(d);

  // send detailed message to customer (if mobile found)
  if(custMobile){
    waOpen(custMobile.startsWith('91')?custMobile:('91'+custMobile), custMsg);
  } else {
    alert('Customer mobile not found — detailed message not sent to customer.');
  }

  // send quick-buy message to sales number (always)
  const quick = buildQuickBuyMsg(d);
  const salesNumber = '917983624797';
  // open to sales
  waOpen(salesNumber, quick);

  // also show both messages in preview
  document.getElementById('output').textContent = custMsg + "\\n\\n" + "Quick-buy sent to sales: " + quick;
}

/* Quick Buy directly to sales (single action) */
function quickBuyToSales(){
  const d = parseInput();
  const quick = buildQuickBuyMsg(d);
  const salesNumber = '917983624797';
  waOpen(salesNumber, quick);
  document.getElementById('output').textContent = quick;
}

</script>

</body>
</html>
