<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Games Planet Mannual Order Form ‚Äì Coupon + COD </title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    input, select, textarea {
      width: 90%; max-width: 400px; padding: 10px; margin: 6px auto;
      font-size: 16px; border: 1px solid #ccc; border-radius: 5px; display: block;
    }
    button {
      padding: 12px 24px; font-size: 18px; margin: 10px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    .pay-btn { background-color: #007bff; color: white; }
    .order-btn { background-color: #28a745; color: white; }
    #deliveryEstimate { white-space: pre-wrap; margin-top: 10px; color: #333; }
  </style>
</head>
<body>

<h2>GamesPlanet Order Form</h2>

<input id="name" placeholder="Name" />
<input id="mobile" placeholder="Mobile" />
<input id="altmobile" placeholder="Alt Mobile (Optional)" />
<input id="email" placeholder="Email" />
<input id="address" placeholder="Address" />
<input id="landmark" placeholder="Landmark" />
<input id="pincode" placeholder="Pincode" />
<input id="state" placeholder="State" readonly />
<input id="city" placeholder="District/City" readonly />
<select id="postoffice"><option value="">Select Post Office</option></select>

<hr/>

<input id="product" placeholder="Product Name" />
<input id="variant" placeholder="Variant (64GB / 128GB etc)" />
<input id="coupon" placeholder="Coupon Code (if any)" />
<select id="paymentmode">
  <option value="prepaid">Prepaid</option>
  <option value="cod">Cash on Delivery</option>
</select>
<input id="baseprice" type="number" placeholder="Base Price (‚Çπ)" />
<input id="discount" type="number" placeholder="Discount (‚Çπ)" readonly />
<input id="amountpaid" type="number" placeholder="Amount Paid (‚Çπ)" />
<input id="restamount" type="number" placeholder="Rest on Delivery (‚Çπ)" readonly />

<div id="deliveryEstimate">Delivery estimate will appear here.</div>

<button class="pay-btn" onclick="payNow()">Pay Now</button>
<button class="order-btn" onclick="sendOrder()">Order on WhatsApp</button>

<script>
let pincodeLatLng = {}, globalDistance = "N/A", globalETA = "N/A", globalEstimatedDateRange = "N/A";

fetch('pincode_data.json')
  .then(res => res.json())
  .then(data => { pincodeLatLng = data; });

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function estimateDeliveryByDistance(distance) {
  let d = parseInt(distance);
  if (isNaN(d)) return "N/A";
  if (d <= 30) return "1 day";
  if (d <= 60) return "1-2 days";
  if (d <= 100) return "2-3 days";
  if (d <= 200) return "3-4 days";
  if (d <= 500) return "4-5 days";
  if (d <= 1000) return "4-6 days";
  if (d <= 1500) return "5‚Äì7 days";
  if (d <= 2000) return "6‚Äì8 days";
  if (d <= 3000) return "6‚Äì10 days";
  return "8‚Äì12 days (sometimes up to 15 days)";
}

function formatDatePlusDays(days) {
  const date = new Date();
  date.setDate(date.getDate() + days);
  return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });
}

function calculateEstimatedRange(etaText) {
  const numbers = etaText.match(/\d+/g);
  if (!numbers) return "N/A";
  const minDay = parseInt(numbers[0]);
  const maxDay = numbers[1] ? parseInt(numbers[1]) : minDay;
  return `${formatDatePlusDays(minDay)} ‚Äì ${formatDatePlusDays(maxDay)}`;
}

document.getElementById("pincode").addEventListener("input", function () {
  const pincode = this.value.trim();
  if (pincode.length === 6) {
    fetch(`https://api.postalpincode.in/pincode/${pincode}`)
      .then(res => res.json())
      .then(data => {
        if (data[0].Status === "Success") {
          const po = data[0].PostOffice[0];
          document.getElementById("state").value = po.State;
          document.getElementById("city").value = po.District;
          const sel = document.getElementById("postoffice");
          sel.innerHTML = '<option value="">Select Post Office</option>';
          data[0].PostOffice.forEach(p => {
            let opt = document.createElement("option");
            opt.value = p.Name;
            opt.text = p.Name;
            sel.appendChild(opt);
          });

          if (pincodeLatLng[pincode]) {
            const rampurLat = 28.8, rampurLng = 79.0;
            const dest = pincodeLatLng[pincode];
            const distance = haversine(rampurLat, rampurLng, dest.lat, dest.lng).toFixed(0);
            const eta = estimateDeliveryByDistance(distance);
            const range = calculateEstimatedRange(eta);

            globalDistance = `${distance} km`;
            globalETA = eta;
            globalEstimatedDateRange = range;

            document.getElementById("deliveryEstimate").innerText =
              `üìç Pincode found ‚Äì Distance: ${globalDistance}\n‚è≥ ETA: ${globalETA}\nüìÖ Estimated Delivery Date: ${globalEstimatedDateRange}\nüì¶ Delivery timeline is based on past experience. Sometimes it may delay by 1‚Äì3 days.`;
          } else {
            globalDistance = "N/A";
            globalETA = "N/A";
            globalEstimatedDateRange = "N/A";
            document.getElementById("deliveryEstimate").innerText = "üìç Pincode found, but no distance data.";
          }
        }
      });
  }
});

const products = ["super mini u box md 16bit sega","aoko game stick","aoko game stick v1","black hawk","black hawk v1","fmcb","fmcb + usb","fmcb + usb optional","fmcb + usb top","gamestick lite","gamestick pro","game stick gd10","gamestick blaster","game box g10","g10","g10v3","g11 pro","g11 pro special edition","g11 pro ultimate edition","gd10","gd30","gd35","gs5","k8","m15 pro","m22","m33","m44","m55","m66","m77","m88","m99","m222","m333","m444","m555","m666","m777","m888","m999","m1000","nintendo switch","nintendo switch oled","nintendo wii","nintendo wii u","nintendo ds","nintendo 3ds","ps1","ps2 slim","ps3 slim","ps3 super slim","ps4 fat","ps4 pro","ps4 slim","xbox 360","xbox one","xbox series s","xbox series x","pandora mini","pandora pro","sega mini u box","sega 16bit mini u box","sup x7m","r35s","r36s","usb","sd card"];

document.getElementById("coupon").addEventListener("input", updateDiscount);
document.getElementById("variant").addEventListener("input", updateDiscount);
document.getElementById("product").addEventListener("input", updateDiscount);
document.getElementById("baseprice").addEventListener("input", updateDiscount);
document.getElementById("paymentmode").addEventListener("change", updateDiscount);

function updateDiscount() {
  const coupon = document.getElementById("coupon").value.trim().toLowerCase();
  const mode = document.getElementById("paymentmode").value;
  const product = document.getElementById("product").value.toLowerCase();
  const variant = document.getElementById("variant").value.toLowerCase();
  const base = parseInt(document.getElementById("baseprice").value) || 0;

  const isKnownProduct = products.some(p => product.includes(p));
  const is64 = variant.includes("64");
  const is128 = variant.includes("128");
  const is256plus = variant.includes("256") || variant.includes("500") || variant.includes("1tb");

  let discount = 0;
  if (coupon === "gpz2025" && mode === "prepaid" && isKnownProduct) {
    if (is64) discount = 200;
    else if (is128) discount = 300;
    else if (is256plus) discount = 500;
  }

  const codCharge = (mode === "cod" && base < 1500) ? 99 : 0;
  const amountPaid = mode === "cod" ? Math.max(500, Math.ceil(base * 0.1)) : base - discount + codCharge;
  const rest = mode === "cod" ? base + codCharge - amountPaid : 0;

  document.getElementById("discount").value = (mode === "prepaid") ? discount : 0;
  document.getElementById("amountpaid").value = amountPaid;
  document.getElementById("restamount").value = rest;
}

function payNow() {
  const amount = document.getElementById("amountpaid").value;
  if (amount) {
    window.open(`upi://pay?pa=gamesplanet@upi&pn=GamesPlanet&am=${amount}`, "_blank");
  } else {
    alert("Please enter the amount first.");
  }
}

function sendOrder() {
  let now = new Date();
  let orderId = String(now.getDate()).padStart(2, '0') + String(now.getMonth() + 1).padStart(2, '0') + now.getFullYear() +
                String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0');

  const getValue = id => document.getElementById(id)?.value || "";

  const paymentMode = getValue("paymentmode");
  const msg = (paymentMode === "cod" ? "üî¥ *COD Order on WhatsApp*" : "üü¢ *Prepaid Order on WhatsApp*") + `

*Order ID:* ${orderId}
*Name:* ${getValue("name")}
*Mobile:* ${getValue("mobile")}
*Alt Mobile:* ${getValue("altmobile")}
*Email:* ${getValue("email")}
*Address:* ${getValue("address")}
*Landmark:* ${getValue("landmark")}
*Pincode:* ${getValue("pincode")}
*State:* ${getValue("state")}
*District/City:* ${getValue("city")}
*Post office:* ${getValue("postoffice")}

*Product:* ${getValue("product")}
*Variant:* ${getValue("variant")}
*Base Price:* ‚Çπ${getValue("baseprice")}
*Discount Applied:* ‚Çπ${getValue("discount")}
*Amount Paid:* ‚Çπ${getValue("amountpaid")}
${paymentMode === "cod" ? "*Rest on delivery:* ‚Çπ" + getValue("restamount") : ""}

üìè Distance: ${globalDistance}
‚è≥ ETA: ${globalETA}
üìÖ Estimated Delivery Date: ${globalEstimatedDateRange}`;

  window.location.href = `https://wa.me/917983624797?text=${encodeURIComponent(msg)}`;
}
</script>

</body>
</html>
