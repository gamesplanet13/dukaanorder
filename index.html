<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GamesPlanet â€“ Quick Order (Prefilled)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 18px; max-width: 1000px; margin: 0 auto; background:#f6f8fb; color:#111;}
    textarea, input[type=text], select { width:100%; padding:8px; border-radius:6px; border:1px solid #dfe6ee; box-sizing:border-box; font-size:14px; }
    textarea { min-height:160px; resize:vertical; }
    .card{ background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 20px rgba(30,50,80,0.06); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    .col{ flex:1; min-width:220px; }
    button{ padding:8px 12px; border-radius:8px; border:1px solid #d1dbe8; background:#0f172a; color:#fff; cursor:pointer; }
    .btn-ghost{ background:#fff; color:#111; }
    .langs{ display:flex; gap:8px; flex-wrap:wrap; }
    .lang-btn{ padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
    .lang-btn.active{ background:#0f172a; color:#fff; border-color:transparent; }
    pre{ white-space:pre-wrap; background:#0b1220; color:#fff; padding:12px; border-radius:8px; max-height:420px; overflow:auto; }
    label{ font-weight:600; display:block; margin-bottom:6px; }
    .sep{ height:1px; background:#e6eef6; margin:12px 0; border-radius:2px; }
    .muted{ color:#556072; font-size:13px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>GamesPlanet â€” WhatsApp Order Helper (Final)</h2>
    <p class="muted">Paste raw order text (from your order page). Choose discounts and language, then Preview or Send via WhatsApp. *Mobile number will be used exactly as entered.*</p>

    <label>Raw order input (paste order text here)</label>
    <textarea id="input" placeholder="Paste order text (name, mobile, address, pincode, price lines)"></textarea>

    <div class="row">
      <div class="col">
        <label>Detected Pincode / City / State</label>
        <input id="pincode" placeholder="e.g. 244901 or Rampur, Uttar Pradesh" />
      </div>
      <div class="col">
        <label>Customer Mobile (enter exactly as you want; don't add +91/91 automatically)</label>
        <input id="mobile" placeholder="e.g. 9876543210 or +919876543210 or 919876543210" />
      </div>
      <div class="col">
        <label>Order ID (optional)</label>
        <input id="orderId" placeholder="#123456 or 123456" />
      </div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div class="col">
        <label><input type="checkbox" id="enablePrepaid"> Enable Prepaid Discount</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="prepaidDiscount" placeholder="Prepaid discount (numeric) e.g. 200" />
          <select id="prepaidType"><option value="flat">â‚¹ Flat</option><option value="pct">% Percent</option></select>
        </div>
      </div>

      <div class="col">
        <label><input type="checkbox" id="enableCod"> Enable COD Discount</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="codDiscount" placeholder="COD discount (numeric) e.g. 0" />
          <select id="codType"><option value="flat">â‚¹ Flat</option><option value="pct">% Percent</option></select>
        </div>
      </div>

      <div class="col">
        <label>Default Language (primary shown)</label>
        <select id="defaultLang">
          <option value="en">English</option>
          <option value="hi">Hindi</option>
          <option value="bn">Bengali</option>
          <option value="mr">Marathi</option>
          <option value="te">Telugu</option>
          <option value="ta">Tamil</option>
          <option value="gu">Gujarati</option>
          <option value="kn">Kannada</option>
          <option value="ml">Malayalam</option>
          <option value="pa">Punjabi</option>
          <option value="or">Odia</option>
        </select>
      </div>
    </div>

    <div class="sep"></div>

    <label>Language Buttons (auto-suggested based on pincode/state)</label>
    <div id="langButtons" class="langs"></div>

    <div class="sep"></div>

    <div class="row" style="margin-bottom:12px">
      <!-- Primary preview/send -->
      <button onclick="previewBoth()">Preview (Thanks & Abandoned)</button>
      <button class="btn-ghost" onclick="copyPreview()">Copy Preview</button>
      <button class="btn-ghost" onclick="sendWhatsApp('thanks')">Send Thanks via WA</button>
      <button class="btn-ghost" onclick="sendWhatsApp('abandoned')">Send Abandoned via WA</button>
      <!-- Original / extra actions -->
      <button class="btn-ghost" onclick="selectAll()">Select All</button>
      <button class="btn-ghost" onclick="clearText()">Clear</button>
      <button class="btn-ghost" onclick="convert()">Convert</button>
      <button class="btn-ghost" onclick="copyAll()">Copy All</button>
      <!-- Prepaid / COD send -->
      <button class="btn-ghost" onclick="sendPrepaidToCustomer()">Send Prepaid â†’ Customer</button>
      <button class="btn-ghost" onclick="sendPrepaidToOwn()">Send Prepaid â†’ Own</button>
      <button class="btn-ghost" onclick="sendCodToCustomer()">Send COD â†’ Customer</button>
      <button class="btn-ghost" onclick="sendCodToOwn()">Send COD â†’ Own</button>
      <!-- alternate full sends -->
      <button class="btn-ghost" onclick="sendThanks()">Send Thanks (alt)</button>
      <button class="btn-ghost" onclick="sendAbandonedCart()">Send Abandoned (alt)</button>
    </div>

    <label>Preview</label>
    <pre id="preview">(Messages will appear here)</pre>
  </div>

<script>
/* ===========================
   Full final script (merged)
   - original parser (product lists)
   - message templates
   - discount controls
   - buttons & functions (all restored)
   ============================ */

// ---------- product & variant lists (original) ----------
const products = ["Super Mini U Box MD 16bit Sega ","aoko game stick","Aoko Game Stick","AOKO GAME STICK","aoko game stick v1","Aoko Game Stick V1","AOKO GAME STICK V1","black hawk","Black Hawk","BLACK HAWK","black hawk v1","Black Hawk V1","BLACK HAWK V1","fmcb","FMCB","FMCB","fmcb + usb","FMCB + USB","FMCB + USB","fmcb + usb optional","FMCB + USB Optional","FMCB + USB OPTIONAL","fmcb + usb top","FMCB + USB Top","FMCB + USB TOP","gamestick lite","Gamestick Lite","GAMESTICK LITE","gamestick pro","Gamestick Pro","GAMESTICK PRO","game stick gd10","Game Stick GD10","GAME STICK GD10","gamestick blaster","Gamestick Blaster","GAMESTICK BLASTER","game box g10","Game Box G10","GAME BOX G10","g10","G10","G10","g10v3","G10V3","G10V3","g11 pro","G11 Pro","G11 PRO","g11 pro special edition","G11 Pro Special Edition","G11 PRO SPECIAL EDITION","g11 pro ultimate edition","G11 Pro Ultimate Edition","G11 PRO ULTIMATE EDITION","gd10","GD10","GD10","gd30","GD30","GD30","gd35","GD35","GD35","gs5","GS5","GS5","k8","K8","K8","m15 pro","M15 Pro","M15 PRO","m22","M22","M22","m33","M33","M33","m44","M44","M44","m55","M55","M55","m66","M66","M66","m77","M77","M77","m88","M88","M88","m99","M99","M99","m222","M222","M222","m333","M333","M333","m444","M444","M444","m555","M555","M555","m666","M666","M666","m777","M777","M777","m888","M888","M888","m999","M999","M999","m1000","M1000","M1000","nintendo switch","Nintendo Switch","NINTENDO SWITCH","nintendo switch oled","Nintendo Switch OLED","NINTENDO SWITCH OLED","nintendo wii","Nintendo Wii","NINTENDO WII","nintendo wii u","Nintendo Wii U","NINTENDO WII U","nintendo ds","Nintendo DS","NINTENDO DS","nintendo 3ds","Nintendo 3DS","NINTENDO 3DS","ps1","PS1","PS1","ps2 slim","PS2 Slim","PS2 SLIM","ps3 slim","PS3 Slim","PS3 SLIM","ps3 super slim","PS3 Super Slim","PS3 SUPER SLIM","ps4 fat","PS4 Fat","PS4 FAT","ps4 pro","PS4 Pro","PS4 PRO","ps4 slim","PS4 Slim","PS4 SLIM","xbox 360","XBOX 360","XBOX 360","xbox one","XBOX One","XBOX ONE","xbox series s","XBOX Series S","XBOX SERIES S","xbox series x","XBOX Series X","XBOX SERIES X","pandora mini","Pandora Mini","PANDORA MINI","pandora pro","Pandora Pro","PANDORA PRO","sega mini u box","Sega Mini U Box","SEGA MINI U BOX","sega 16bit mini u box","Sega 16bit Mini U Box","SEGA 16BIT MINI U BOX","sup x7m","Sup X7M","SUP X7M","r35s","R35S","R35S","r36s","R36S","R36S","usb","USB","USB","sd card","SD Card","SD CARD"];
const variants = ["64gb","128gb","256gb","500gb","1tb","64gb optional","128gb optional","256gb optional","500gb optional","1tb optional","dual","single","sd card 64gb","sd card 128gb","sd card 256gb","64GB","128GB","256GB","500GB","1TB","64GB Optional","128GB Optional","256GB Optional","500GB Optional","1TB Optional","Dual","Single","SD CARD 64GB","SD CARD 128GB","SD CARD 256GB","64GB OPTIONAL","128GB OPTIONAL","256GB OPTIONAL","500GB OPTIONAL","1TB OPTIONAL","DUAL","SINGLE"];

// ---------- language map ----------
const stateToLang = {
  'uttar pradesh': ['hi','en','pa'],
  'west bengal': ['bn','en','hi'],
  'maharashtra': ['mr','en','hi'],
  'telangana': ['te','en','hi'],
  'andhra pradesh': ['te','en','hi'],
  'tamil nadu': ['ta','en','hi'],
  'gujarat': ['gu','en','hi'],
  'karnataka': ['kn','en','hi'],
  'kerala': ['ml','en','hi'],
  'punjab': ['pa','en','hi'],
  'odisha': ['or','en','hi']
};
const langsMeta = {en:'English',hi:'Hindi',bn:'Bengali',mr:'Marathi',te:'Telugu',ta:'Tamil',gu:'Gujarati',kn:'Kannada',ml:'Malayalam',pa:'Punjabi',or:'Odia'};

// ---------- templates (English + Hindi full; others placeholders) ----------
const templates = {
  en: {
    thanks: `ğŸŒŸ *GamesPlanet*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ™ Hello *{{name}}*, thank you for your order *{{orderId}}*\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ“¦ *Product:* {{product}}\nğŸ“ *Pincode:* {{pincode}}\nğŸ“ *Distance:* {{distance}} km\n\nâ³ *Estimated Delivery:* {{eta}}\nğŸšš *Shipping:* Your order will be shipped between 8PMâ€“10PM.\nğŸ”— *Tracking:* Will update on our website after dispatch.\n\nğŸ–¼ï¸ On request, we can send *parcel pic & tracking number* here on WhatsApp.\n\nğŸ’š *Team GamesPlanet*`,
    abandoned: `ğŸŒŸ *GamesPlanet*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ™ Hello *{{name}}*, your order is incomplete!\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ“ *Order Details:*\nâ€“ Order ID: {{orderId}}\nâ€“ Product: {{product}}\nâ€“ Base Price: â‚¹{{basePrice}}\nğŸ“ City: {{city}}\nğŸ“ Distance: {{distance}} km\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ’° *Prepaid Offer*\nPrice: â‚¹{{basePrice}} â€“ {{prepaidDiscountDisplay}} = â‚¹{{prepaidFinal}}\nâ³ Delivery: {{eta}}\n\nğŸ’µ *Cash on Delivery (COD)*\nPrice: â‚¹{{basePrice}} (no discount)\nâ¡ Advance: â‚¹{{codAdvance}}\nâ¡ Remaining on Delivery: â‚¹{{codRemaining}}\nâ³ Delivery: {{codEta}}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ‘‰ Complete payment soon to confirm your order.\n\nğŸ’š *Team GamesPlanet*`
  },
  hi: {
    thanks: `ğŸŒŸ *GamesPlanet*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ™ à¤¨à¤®à¤¸à¥à¤¤à¥‡ *{{name}}*, à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° *{{orderId}}* à¤•à¥‡ à¤²à¤¿à¤ à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ“¦ *à¤ªà¥à¤°à¥‹à¤¡à¤•à¥à¤Ÿ:* {{product}}\nğŸ“ *à¤ªà¤¿à¤¨à¤•à¥‹à¤¡:* {{pincode}}\nğŸ“ *à¤¦à¥‚à¤°à¥€:* {{distance}} à¤•à¤¿à¤®à¥€\n\nâ³ *à¤…à¤¨à¥à¤®à¤¾à¤¨à¤¿à¤¤ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€:* {{eta}}\nğŸšš *à¤¶à¤¿à¤ªà¤¿à¤‚à¤—:* à¤†à¤ªà¤•à¤¾ à¤†à¤°à¥à¤¡à¤° à¤¶à¤¾à¤® 8PMâ€“10PM à¤•à¥‡ à¤¬à¥€à¤š à¤­à¥‡à¤œà¤¾ à¤œà¤¾à¤à¤—à¤¾à¥¤\nğŸ”— *à¤Ÿà¥à¤°à¥ˆà¤•à¤¿à¤‚à¤—:* à¤¡à¤¿à¤¸à¥à¤ªà¥ˆà¤š à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¹à¤®à¤¾à¤°à¥€ à¤µà¥‡à¤¬à¤¸à¤¾à¤‡à¤Ÿ à¤ªà¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤¹à¥‹à¤—à¥€à¥¤\n\nğŸ–¼ï¸ à¤…à¤¨à¥à¤°à¥‹à¤§ à¤ªà¤° à¤¹à¤® *à¤ªà¤¾à¤°à¥à¤¸à¤² à¤•à¥€ à¤¤à¤¸à¥à¤µà¥€à¤° à¤”à¤° à¤Ÿà¥à¤°à¥ˆà¤•à¤¿à¤‚à¤— à¤¨à¤‚à¤¬à¤°* à¤µà¥à¤¹à¤¾à¤Ÿà¥à¤¸à¤à¤ª à¤ªà¤° à¤­à¥‡à¤œ à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤\n\nğŸ’š *à¤Ÿà¥€à¤® GamesPlanet*`,
    abandoned: `ğŸŒŸ *GamesPlanet*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ™ à¤¨à¤®à¤¸à¥à¤¤à¥‡ *{{name}}*, à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤…à¤§à¥‚à¤°à¤¾ à¤¹à¥ˆ!\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ“ *à¤‘à¤°à¥à¤¡à¤° à¤µà¤¿à¤µà¤°à¤£:*\nâ€“ à¤‘à¤°à¥à¤¡à¤° ID: {{orderId}}\nâ€“ à¤ªà¥à¤°à¥‹à¤¡à¤•à¥à¤Ÿ: {{product}}\nâ€“ à¤¬à¥‡à¤¸ à¤ªà¥à¤°à¤¾à¤‡à¤¸: â‚¹{{basePrice}}\nğŸ“ à¤¸à¤¿à¤Ÿà¥€: {{city}}\nğŸ“ à¤¦à¥‚à¤°à¥€: {{distance}} à¤•à¤¿à¤®à¥€\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ’° *à¤ªà¥à¤°à¥€à¤ªà¥‡à¤¡ à¤‘à¤«à¤°*\nà¤•à¥€à¤®à¤¤: â‚¹{{basePrice}} â€“ {{prepaidDiscountDisplay}} = â‚¹{{prepaidFinal}}\nâ³ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€: {{eta}}\n\nğŸ’µ *à¤•à¥ˆà¤¶ à¤‘à¤¨ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ (COD)*\nà¤•à¥€à¤®à¤¤: â‚¹{{basePrice}} (à¤•à¥‹à¤ˆ à¤›à¥‚à¤Ÿ à¤¨à¤¹à¥€à¤‚)\nâ¡ à¤à¤¡à¤µà¤¾à¤‚à¤¸: â‚¹{{codAdvance}}\nâ¡ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤° à¤¬à¤¾à¤•à¥€: â‚¹{{codRemaining}}\nâ³ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€: {{codEta}}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ‘‰ à¤…à¤ªà¤¨à¤¾ à¤ªà¥‡à¤®à¥‡à¤‚à¤Ÿ à¤œà¤²à¥à¤¦ à¤ªà¥‚à¤°à¤¾ à¤•à¤°à¥‡à¤‚ à¤¤à¤¾à¤•à¤¿ à¤‘à¤°à¥à¤¡à¤° à¤•à¤¨à¥à¤«à¤°à¥à¤® à¤¹à¥‹ à¤¸à¤•à¥‡à¥¤\n\nğŸ’š *à¤Ÿà¥€à¤® GamesPlanet*`
  },
  // placeholders
  bn: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Bengali)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Bengali)`},
  mr: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Marathi)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Marathi)`},
  te: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Telugu)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Telugu)`},
  ta: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Tamil)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Tamil)`},
  gu: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Gujarati)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Gujarati)`},
  kn: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Kannada)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Kannada)`},
  ml: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Malayalam)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Malayalam)`},
  pa: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Punjabi)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Punjabi)`},
  or: {thanks: `ğŸŒŸ *GamesPlanet*\n\n... (Odia)`, abandoned: `ğŸŒŸ *GamesPlanet*\n\n... (Odia)`},
};

// ---------- helpers ----------
function formatNumber(n){ return (''+n).replace(/\B(?=(\d{3})+(?!\d))/g,","); }
function pickLanguagesFromInput(text){
  const low = (text||'').toLowerCase();
  for(const st in stateToLang) if(low.includes(st)) return stateToLang[st];
  if(/\b\d{6}\b/.test(text)) return ['hi','en'];
  return ['en','hi'];
}

// minimal pincode lat/lng (replace with full file if needed)
const pincodeLatLng = { '244901': {lat:28.82, lng:79.02, city:'Rampur', state:'Uttar Pradesh'} };
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c;
}
function estimateDeliveryByDistance(distance) {
  const d = Number(distance);
  if (d <= 30) return "1 day";
  else if (d <= 60) return "1-2 days";
  else if (d <= 100) return "2-3 days";
  else if (d <= 200) return "3-4 days";
  else if (d <= 500) return "4-5 days";
  else if (d <= 1000) return "4-6 days";
  else return "6â€“10 days";
}

// ---------- parsing (robust) ----------
function parseInput(){
  const raw = document.getElementById("input").value || "";
  const lower = raw.toLowerCase();

  // order id
  let orderId = (raw.match(/#\s*\d{5,}/)?.[0] || "") .replace(/\s+/g,'');
  if(!orderId){ const firstLine = (raw.split('\n').map(s=>s.trim()).find(s=>s) || ""); const m = firstLine.match(/\d{5,}/); if(m) orderId = "#" + m[0]; }
  if(!orderId) orderId = document.getElementById('orderId').value || "Not found";

  // name
  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\n([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\nMobile/i)?.[1] || "Customer").trim();

  // mobile (use explicit field first; else find in raw) â€” do NOT force +91/91
  const explicit = (document.getElementById('mobile').value || "").trim();
  let mobile = explicit || (raw.match(/(?:\+?91[-\s]?)?[6-9]\d{9}/)?.[0] || "");
  mobile = mobile.replace(/^\+/, "").replace(/\s+/g,"");

  const email = (raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)?.[0] || "").trim();

  // address & pincode
  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:payments|payment|additional|customer|mobile|email|$))/i)?.[1] ||
                  raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim().replace(/\s+/g,' ').trim();

  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || document.getElementById('pincode').value || "").trim();

  // product detection
  let detectedProduct = "Unknown Product";
  const afterItem = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItem && afterItem.length>2) detectedProduct = afterItem;
  else{
    const lowerRaw = raw.toLowerCase(); products.sort((a,b)=>b.length-a.length);
    for (let p of products) if (lowerRaw.includes(p.toLowerCase())) { detectedProduct = p; break; }
  }

  // variant detection
  let variant = "";
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim();
  else {
    const vInName = detectedProduct.match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1];
  }

  // price parsing
  const basePrice = ((raw.match(/1x\s*â‚¹?\s*([\d,]+)/i)?.[1] || raw.match(/base\s*price\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();
  const discount = (raw.match(/coupon\s*discount.*?(-â‚¹\s*[\d,]+)/i)?.[1] || raw.match(/discount\s*applied\s*[:â‚¹\s-]*([\d,]+)/i)?.[1] || "0").replace(/[^\d]/g,'');
  const amountPaid = ((raw.match(/total\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || raw.match(/amount\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();

  // geo: city/state/distance/eta
  let city="Unknown", state="Unknown", distance="N/A", eta="N/A";
  if (pincode && pincodeLatLng[pincode]) {
    const dest = pincodeLatLng[pincode];
    city = dest.city || "Unknown"; state = dest.state || "Unknown";
    distance = Math.round(haversine(28.8,79.0,dest.lat,dest.lng));
    eta = estimateDeliveryByDistance(distance);
  }

  return { orderId, name, mobile, email, address, pincode, basePrice, discount, amountPaid, detectedProduct, variant, city, state, distance, eta };
}

// ---------- discount calc ----------
function computeDiscountedFor(baseStr, enabled, valStr, type){
  const base = Number((baseStr||"0").toString().replace(/,/g,''))||0;
  const val = Number(valStr||0)||0;
  if(!enabled) return {display:'â‚¹0', final: base};
  if(type==='flat'){ return { display: 'â‚¹'+formatNumber(val), final: Math.max(0, base - val) }; }
  const disc = Math.round(base * (val/100)); return { display: val + '%', final: Math.max(0, base - disc) };
}

// ---------- message builders ----------
function buildPrepaidMessageFull(d, prepaid){
  const estWindow = d.eta || "";
  return `ğŸŸ¢ Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Email: ${d.email}
Address: ${d.address}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${formatNumber(d.basePrice)}
Discount Applied: ${prepaid.display}
Amount Payable (Prepaid): â‚¹${formatNumber(prepaid.final)}

ğŸ“ Distance: ${d.distance} km
â³ Prepaid Order ETA: ${d.eta}
ğŸ“… Estimated Delivery: ${estWindow}`;
}

function buildCodMessageFull(d, cod){
  const base = Number((d.basePrice||"0").toString().replace(/,/g,''))||0;
  const advance = Math.max(500, Math.round(base * 0.10));
  const rest = Math.max(0, base - advance);
  const codEta = d.eta ? (function(e){ const nums=(e.match(/\d+/g)||[]).map(Number); if(nums.length===0) return e; const min=nums[0]+2; const max=(nums[1]||nums[0])+3; return (min===max)? min+' days': min+'-'+max+' days'; })(d.eta) : d.eta;

  return `ğŸ”´ COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Email: ${d.email}
Address: ${d.address}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${formatNumber(base)}
Discount Applied: ${cod.display}
Amount Paid (Advance): â‚¹${formatNumber(advance)}
Rest on Delivery: â‚¹${formatNumber(rest)}

ğŸ“ Distance: ${d.distance} km
â³ COD Order ETA: ${codEta}
ğŸ“… Estimated Delivery: ${codEta}`;
}

// ---------- template rendering ----------
function replacePlaceholders(template, data){
  return template.replace(/{{\s*(\w+)\s*}}/g, (_,k)=> data[k] || '');
}

function buildMessage(type, langCode){
  const d = parseInput();
  const prepaidEnabled = document.getElementById('enablePrepaid').checked;
  const prepaidVal = document.getElementById('prepaidDiscount').value || '0';
  const prepaidType = document.getElementById('prepaidType').value;
  const codEnabled = document.getElementById('enableCod').checked;
  const codVal = document.getElementById('codDiscount').value || '0';
  const codType = document.getElementById('codType').value;

  const prepaid = computeDiscountedFor(d.basePrice, prepaidEnabled, prepaidVal, prepaidType);
  const cod = computeDiscountedFor(d.basePrice, codEnabled, codVal, codType);

  const base = Number((d.basePrice||"0").toString().replace(/,/g,''))||0;
  const codAdvance = Math.max(500, Math.round(base * 0.10));
  const codRemaining = Math.max(0, base - codAdvance);

  const tplSet = templates[langCode] || templates['en'];
  const tpl = tplSet[type] || templates['en'][type];

  const data = {
    name: d.name,
    orderId: d.orderId,
    product: d.detectedProduct,
    basePrice: formatNumber(d.basePrice),
    city: d.city,
    pincode: d.pincode,
    distance: d.distance,
    eta: d.eta,
    prepaidDiscountDisplay: prepaid.display,
    prepaidFinal: formatNumber(prepaid.final),
    codAdvance: formatNumber(codAdvance),
    codRemaining: formatNumber(codRemaining),
    codEta: d.eta
  };

  return replacePlaceholders(tpl, data);
}

// ---------- UI: language buttons ----------
function renderLangButtons(){
  const raw = document.getElementById('input').value || '';
  const suggested = pickLanguagesFromInput(raw);
  const container = document.getElementById('langButtons');
  container.innerHTML = '';
  suggested.forEach(code=>{
    const btn = document.createElement('button'); btn.className='lang-btn active'; btn.innerText = langsMeta[code] || code; btn.dataset.lang=code;
    btn.onclick = ()=>{ document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
    container.appendChild(btn);
  });
  Object.keys(langsMeta).forEach(code=>{
    if(!suggested.includes(code)){
      const btn = document.createElement('button'); btn.className='lang-btn'; btn.innerText = langsMeta[code]; btn.dataset.lang=code;
      btn.onclick = ()=>{ btn.classList.toggle('active'); };
      container.appendChild(btn);
    }
  });
}
document.getElementById('input').addEventListener('input', renderLangButtons);
document.getElementById('pincode').addEventListener('input', renderLangButtons);
renderLangButtons();

// ---------- preview & send ----------
function previewBoth(){
  const active = Array.from(document.querySelectorAll('.lang-btn.active')).map(b=>b.dataset.lang);
  const primary = document.getElementById('defaultLang').value || active[0] || 'en';
  let out = `-- Primary: ${langsMeta[primary] || primary} --\n\n`;
  out += `--- THANKS (${langsMeta[primary]}) ---\n` + buildMessage('thanks', primary) + '\n\n';
  out += `--- ABANDONED (${langsMeta[primary]}) ---\n` + buildMessage('abandoned', primary) + '\n\n';

  const others = active.filter(l=>l!==primary).slice(0,4);
  others.forEach(l=>{
    out += `--- THANKS (${langsMeta[l]}) ---\n` + buildMessage('thanks', l) + '\n\n';
    out += `--- ABANDONED (${langsMeta[l]}) ---\n` + buildMessage('abandoned', l) + '\n\n';
  });

  document.getElementById('preview').innerText = out;
}
function copyPreview(){ navigator.clipboard.writeText(document.getElementById('preview').innerText).then(()=>alert('Preview copied')); }
function copyAll(){ copyPreview(); }
function convert(){ previewBoth(); }

// ---------- WhatsApp helper (do NOT add +91 automatically) ----------
function waOpen(number, msg){
  if(!number) { alert('Mobile number missing. Enter in Mobile field or include in raw input.'); return; }
  const cleaned = number.replace(/\s+/g,'');
  const url = `https://wa.me/${encodeURIComponent(cleaned)}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

// get mobile (explicit field first; else from raw)
function getCustomerMobile(){
  const explicit = (document.getElementById('mobile').value || '').trim();
  if(explicit) return explicit.replace(/\s+/g,'');
  const raw = document.getElementById('input').value || '';
  const any = raw.match(/(?:\+?91[-\s]?)?[6-9]\d{9}/);
  return any ? any[0].replace(/^\+/, '').replace(/\s+/g,'') : '';
}

// ---------- Prepaid/COD small order messages and functions ----------
function buildPrepaidOrderMessage(){
  const d = parseInput();
  const enabled = document.getElementById('enablePrepaid').checked;
  const val = document.getElementById('prepaidDiscount').value || '0';
  const type = document.getElementById('prepaidType').value;
  const disc = computeDiscountedFor(d.basePrice, enabled, val, type);
  return `ğŸŸ¢ Prepaid Order\nOrder ID: ${d.orderId}\nName: ${d.name}\nMobile: ${d.mobile || getCustomerMobile()}\nProduct: ${d.detectedProduct}\nBase Price: â‚¹${formatNumber(d.basePrice)}\nDiscount: ${disc.display}\nPayable: â‚¹${formatNumber(disc.final)}`;
}

function buildCodOrderMessage(){
  const d = parseInput();
  const enabled = document.getElementById('enableCod').checked;
  const val = document.getElementById('codDiscount').value || '0';
  const type = document.getElementById('codType').value;
  const disc = computeDiscountedFor(d.basePrice, enabled, val, type);
  const base = Number((d.basePrice||"0").toString().replace(/,/g,''))||0;
  const advance = Math.max(500, Math.round(base * 0.10));
  const rest = Math.max(0, base - advance);
  return `ğŸ”´ COD Order\nOrder ID: ${d.orderId}\nName: ${d.name}\nMobile: ${d.mobile || getCustomerMobile()}\nProduct: ${d.detectedProduct}\nBase Price: â‚¹${formatNumber(base)}\nDiscount: ${disc.display}\nCOD Advance: â‚¹${formatNumber(advance)}\nRemaining on Delivery: â‚¹${formatNumber(rest)}`;
}

function sendPrepaidToCustomer(){ waOpen(getCustomerMobile(), buildPrepaidOrderMessage()); }
function sendPrepaidToOwn(){ waOpen(getOwnNumber(), buildPrepaidOrderMessage()); }
function sendCodToCustomer(){ waOpen(getCustomerMobile(), buildCodOrderMessage()); }
function sendCodToOwn(){ waOpen(getOwnNumber(), buildCodOrderMessage()); }

function sendThanks(){
  const primary = document.getElementById('defaultLang').value || 'en';
  const msg = buildMessage('thanks', primary);
  waOpen(getCustomerMobile(), msg);
}
function sendAbandonedCart(){
  const primary = document.getElementById('defaultLang').value || 'en';
  const msg = buildMessage('abandoned', primary);
  waOpen(getCustomerMobile(), msg);
}

// alternate send buttons (same behavior)
function sendWhatsApp(which){
  const primary = document.getElementById('defaultLang').value || 'en';
  const msg = buildMessage(which, primary);
  waOpen(getCustomerMobile(), msg);
}

// own number for testing / records
function getOwnNumber(){ return '7983624797'; }

</script>
</body>
</html>
