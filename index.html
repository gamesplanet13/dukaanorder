<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GamesPlanet Final Order Converter (Patched)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 980px; margin: 0 auto; }
    textarea { width: 100%; height: 280px; font-size: 14px; }
    pre { background: #f6f7f9; padding: 12px; white-space: pre-wrap; font-size: 14px; border-radius: 8px; border: 1px solid #e6e6e6; }
    button { padding: 10px 14px; font-size: 14px; margin: 6px 6px 6px 0; cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background:#fff; }
    .row { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
    .hr { height:1px; background:#e6e6e6; margin:14px 0; }
  </style>
</head>
<body>

<h2>GamesPlanet Final Order Converter (Patched)</h2>

<textarea id="input" placeholder="Paste order details here"></textarea>

<div class="row">
  <button onclick="selectAll()">Select All</button>
  <button onclick="clearText()">Clear</button>
  <button onclick="convert()">Convert (Preview Both)</button>
  <button onclick="copyAll()">Copy All</button>
</div>

<div class="row">
  <button onclick="sendPrepaidToCustomer()">Send Prepaid to Customer</button>
  <button onclick="sendPrepaidToOwn()">Send Prepaid to Own</button>
  <button onclick="sendCodToCustomer()">Send COD to Customer</button>
  <button onclick="sendCodToOwn()">Send COD to Own</button>
</div>

<div class="row">
  <button onclick="sendThanks()">Send Thanks</button>
  <button onclick="sendAbandonedCart()">Send Abandoned Cart</button>
</div>

<div class="hr"></div>
<pre id="output"></pre>

<script>
// ---------- Load pincode data ----------
let pincodeLatLng = {};
fetch('pincode_data.json')
  .then(r => r.json())
  .then(d => { pincodeLatLng = d; })
  .catch(e => console.log("Error loading pincode data:", e));

// ---------- Product & Variant lists (trimmed) ----------
const products = ["Super Mini U Box MD 16bit Sega ","aoko game stick","Aoko Game Stick","AOKO GAME STICK","fmcb","FMCB","fmcb + usb","gamestick lite","Gamestick Lite","GAMESTICK LITE","m88","M88","m99","M99","sd card","SD Card","usb","USB"];
const variants = ["64gb","128gb","256gb","500gb","1tb","64GB","128GB","256GB"];

// ---------- Helpers ----------
function selectAll(){ const t = document.getElementById("input"); t.focus(); t.select(); }
function clearText(){ document.getElementById("input").value=""; document.getElementById("output").textContent=""; }
function copyAll(){ navigator.clipboard.writeText(document.getElementById("output").textContent).then(()=>alert("Output copied!")); }
function encodeForWA(text){ return encodeURIComponent(text); }
function waOpen(number, msg){ window.open(`https://wa.me/${number}?text=${encodeForWA(msg)}`, "_blank"); }
function getOwnNumber(){ return "917983624797"; }

// Prefer explicit mobile line; fallback to any 10-digit match
function getCustomerMobile() {
  const raw = document.getElementById("input").value;
  const line = raw.match(/(?:mobile|phone)\s*[:\n]\s*([+]?91[-\s]?\d{10}|\d{10})/i)?.[1];
  if (line) return line.replace(/\D/g,"").replace(/^0+/, "");
  const any = raw.match(/(?:\+?91[-\s]?)?\d{10}/);
  return any ? any[0].replace(/\D/g,"").replace(/^0+/, "") : "";
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function estimateDeliveryByDistance(distance) {
  const d = Number(distance);
  if (d <= 30) return "1 day";
  else if (d <= 60) return "1-2 days";
  else if (d <= 100) return "2-3 days";
  else if (d <= 200) return "3-4 days";
  else if (d <= 500) return "4-5 days";
  else if (d <= 1000) return "4-6 days";
  else if (d <= 1500) return "5â€“7 days";
  else if (d <= 2000) return "6â€“8 days";
  else if (d <= 3000) return "6â€“10 days";
  else return "8â€“12 days (sometimes up to 15 days)";
}
function parseEtaRange(etaStr){ if(!etaStr || etaStr==="N/A") return null; const nums = (etaStr.match(/\d+/g)||[]).map(n=>parseInt(n,10)); if(nums.length === 1) return {min: nums[0], max: nums[0]}; if(nums.length >= 2) return {min: nums[0], max: nums[1]}; return null; }
function bumpEtaRangeString(etaStr, addMin=2, addMax=3){ const r = parseEtaRange(etaStr); if(!r) return etaStr; const min = r.min + addMin; const max = r.max + addMax; return (min===max) ? `${min} days` : `${min}-${max} days`; }
function todayStrOffset(days){ const d = new Date(); d.setDate(d.getDate()+days); return d.toLocaleDateString('en-IN', {day:'2-digit', month:'short'}); }
function estimatedWindowFromEta(etaStr){ const r = parseEtaRange(etaStr); if(!r) return etaStr || ""; const start = todayStrOffset(r.min); const end   = todayStrOffset(r.max); return (r.min===r.max) ? `${start}` : `${start} to ${end}`; }

// ---------- New: COD & Discount helpers (with M88 special case) ----------
function computeCodCharges(basePrice){ basePrice = Number(basePrice) || 0; if(basePrice > 0 && basePrice < 1499) return 99; return 0; }

function computeCodAmountsForProduct(d){
  // special M88 handling: COD base fixed 7499
  let base = Number(d.basePrice) || 0;
  const prod = (d.detectedProduct||'').toLowerCase();
  if(prod.indexOf('m88') !== -1) base = 7499;

  const codCharges = computeCodCharges(base);
  // Advance: minimum â‚¹500 OR 10% of base (whichever is higher)
  const advance = Math.max(500, Math.round(base * 0.10));
  const rest = Math.max(0, (base + codCharges) - advance);
  return { advance, rest, codCharges, codBase: base };
}

function computePrepaidDiscount(d, paymentMethod){
  const base = Number(d.basePrice) || 0;
  if(!base || base <= 0) return 0;
  if(paymentMethod !== 'wa_qr') {
    // No prepaid discount unless full QR payment
    return 0;
  }

  const prod = (d.detectedProduct || '').toLowerCase();
  const variant = (d.variant || '').toLowerCase();
  const notes = ((d.notes||'') + ' ' + (d.extra || '')).toLowerCase();
  const containsAny = (str, arr) => arr.some(tok => str.indexOf(tok) !== -1);

  // M88 prepaid special price => final 6699
  if(prod.indexOf('m88') !== -1){
    return base > 6699 ? base - 6699 : Math.max(0, base - 6699);
  }

  // FMCB / PS2 + usb/hdd/pd/ssd/combo/pendrive/500gb => 5%
  if( (prod.indexOf('fmcb') !== -1 || prod.indexOf('ps2') !== -1)
      && containsAny(variant + ' ' + notes, ['usb','hdd','pd','ssd','combo','pendrive','500gb']) ){
    return Math.round(base * 0.05);
  }

  // Gamestick/gamebox/sd card fixed discounts by size
  if( containsAny(prod, ['gamestick','game stick','gamebox','sd card','sdcard','sd-card'])
      || containsAny(variant, ['64','128','256']) ){
    if(variant.indexOf('64') !== -1 || prod.indexOf('64gb') !== -1) return 200;
    if(variant.indexOf('128') !== -1 || prod.indexOf('128gb') !== -1) return 300;
    if(variant.indexOf('256') !== -1 || prod.indexOf('256gb') !== -1) return 500;
    return 0;
  }

  return 0;
}

// ---------- Robust Parser (adapted from original) ----------
function parseInput(){
  const raw = document.getElementById("input").value;
  const input = raw.toLowerCase();

  let orderId = (raw.match(/#\s*\d{5,}/)?.[0] || "").replace(/\s+/g,'');
  if(!orderId){
    const firstLine = (raw.split('\n').map(s=>s.trim()).find(s=>s) || "");
    const m = firstLine.match(/\d{6,}/);
    if(m) orderId = "#" + m[0];
  }
  if(!orderId) orderId = "Not found";

  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\n([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\nMobile/i)?.[1] || "Customer").trim();
  const mobile = (raw.match(/mobile\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\+?91[-\s]?\d{10}/)?.[0] || "").trim();
  const altMobile = (raw.match(/alternate\s*mobile(?:\s*number)?\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/Alt(?:ernate)?\s*Mobile\s*\n?([^\n]+)/i)?.[1] || "").trim();
  const email = (raw.match(/email\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)?.[0] || "").trim();

  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:Payments|Payment|Additional|Customer|Mobile|Email|$))/i)?.[1] ||
                  raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim().replace(/\s+/g,' ').trim();

  let landmark = (raw.match(/landmark\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim();
  if(!landmark){
    const near = address.match(/\b(?:near|opp(?:osite)?|behind|beside)\b[^,;|]+/i);
    if(near) landmark = near[0].trim();
  }

  const postOffice = (raw.match(/post\s*office\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim();
  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || "").trim();

  const basePrice = ((raw.match(/1x\s*â‚¹?\s*([\d,]+)/i)?.[1] || raw.match(/base\s*price\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();

  let discount = "0";
  const couponLine = raw.match(/coupon\s*discount.*?(-â‚¹\s*[\d,]+)/i);
  if (couponLine) discount = couponLine[1].replace(/[^\d]/g,'');
  else {
    const d2 = raw.match(/discount\s*applied\s*[:â‚¹\s-]*([\d,]+)/i);
    if (d2) discount = d2[1].replace(/,/g,'');
  }

  const amountPaid = ((raw.match(/total\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/\bpaid\b\s*[:â‚¹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/amount\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();

  let detectedProduct = "Unknown Product";
  const afterItem = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItem && afterItem.length>2) detectedProduct = afterItem.toUpperCase();
  if(detectedProduct==="Unknown Product"){
    const lower = input;
    products.sort((a,b)=>b.length-a.length);
    for (let p of products){ if (lower.includes(p.toLowerCase())) { detectedProduct = p.toUpperCase(); break; } }
  }

  let variant = "";
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim().toUpperCase();
  else {
    const vInName = detectedProduct.match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1].toUpperCase();
  }

  let city = "Unknown", state = "Unknown", distance = "N/A", eta = "N/A";
  if (pincode && pincodeLatLng[pincode]) {
    const dest = pincodeLatLng[pincode];
    city = dest.city || "Unknown";
    state = dest.state || "Unknown";
    distance = haversine(28.8,79.0,dest.lat,dest.lng).toFixed(0); // Rampur approx
    eta = estimateDeliveryByDistance(distance);
  }

  return {
    orderId, name, mobile, altMobile, email,
    address, landmark, postOffice, pincode,
    basePrice, discount, amountPaid,
    detectedProduct, variant,
    city, state, distance, eta
  };
}

// ---------- Message builders (patched to use computed values) ----------
function buildPrepaidMessage(d){
  const estWindow = d.eta && d.eta!=="N/A" ? estimatedWindowFromEta(d.eta) : "";
  // detect payment method from input: look for 'whatsapp qr' or 'wa_qr' lowercase
  const raw = document.getElementById('input').value.toLowerCase();
  const paymentMethod = /wa[_\s-]?qr|whatsapp\s*qr|whatsappqr/.test(raw) ? 'wa_qr' : 'other';

  const prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice || 0) - prepaidDiscount);
  // attach computed to d for reuse
  d._computed = d._computed || {};
  d._computed.prepaidDiscount = prepaidDiscount;
  d._computed.prepaidAmount = prepaidAmount;

  return `ğŸŸ¢ Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${d.basePrice}
Discount Applied: â‚¹${d._computed.prepaidDiscount}
Amount Paid: â‚¹${d._computed.prepaidAmount}

ğŸ“ Distance: ${d.distance} km
â³ Prepaid Order ETA: ${d.eta}
ğŸ“… Estimated Delivery: ${estWindow}`;
}

function buildCodMessage(d){
  // compute COD amounts (includes M88 special pricing)
  const codInfo = computeCodAmountsForProduct(d);
  d._computed = d._computed || {};
  d._computed.codCharges = codInfo.codCharges;
  d._computed.codAdvance = codInfo.advance;
  d._computed.codRestOnDelivery = codInfo.rest;
  d._computed.codBase = codInfo.codBase;

  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;
  const estCodWindow = codEta && codEta!=="N/A" ? estimatedWindowFromEta(codEta) : "";

  return `ğŸ”´ COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${d._computed.codBase}
COD Charges: â‚¹${d._computed.codCharges}
Amount Paid (Advance): â‚¹${d._computed.codAdvance}
Rest on Delivery: â‚¹${d._computed.codRestOnDelivery}

ğŸ“ Distance: ${d.distance} km
â³ COD Order ETA: ${codEta}
ğŸ“… Estimated Delivery: ${estCodWindow}`;
}

// ---------- Preview both ----------
function convert(){
  const d = parseInput();
  const prepaid = buildPrepaidMessage(d);
  const cod = buildCodMessage(d);
  document.getElementById("output").textContent = prepaid + "\n\n" + cod;
}

// ---------- Senders ----------
function sendPrepaidToCustomer(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendPrepaidToOwn(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  waOpen(getOwnNumber(), msg);
}
function sendCodToCustomer(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendCodToOwn(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  waOpen(getOwnNumber(), msg);
}

// ---------- Optional extras (unchanged) ----------
function sendThanks() {
  const d = parseInput();
  const msg =
`ğŸŒŸ GamesPlanet
ğŸ™ Hello ${d.name} ji, thank you for your order ${d.orderId}.
ğŸ“¦ Product: ${d.detectedProduct} (${d.variant})
ğŸ“ Pincode: ${d.pincode} | ğŸ“ Distance: ${d.distance} km
â³ Estimated Delivery: ${d.eta}
ğŸšš Your order will be shipped soon between 8PMâ€“10PM.
ğŸ”— Tracking will update on our website after dispatch.
ğŸ–¼ï¸ On request, we can send *parcel pic & tracking number* here on WhatsApp.
ğŸ’š Team GamesPlanet`;
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendAbandonedCart() {
  const d = parseInput();
  const base = parseInt(d.basePrice || "0",10);
  const discount = parseInt(d.discount || "0",10);
  // ensure computed values are set
  const paymentMethod = /wa[_\s-]?qr|whatsapp\s*qr|whatsappqr/.test(document.getElementById('input').value.toLowerCase()) ? 'wa_qr' : 'other';
  d._computed = d._computed || {};
  d._computed.prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(base - d._computed.prepaidDiscount, 0);
  const codInfo = computeCodAmountsForProduct(d);
  const codAdvance = codInfo.advance;
  const codRemaining = codInfo.rest;
  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;

  const msg =
`ğŸŒŸ GamesPlanet

ğŸ™ Hello ${d.name} ji,

ğŸ“ Incomplete Order Details:
â€“ Order ID: ${d.orderId}
â€“ Product: ${d.detectedProduct} (${d.variant})
â€“ Base Price: â‚¹${base}
ğŸ“ City: ${d.city}
ğŸ“ Distance: ${d.distance} km

ğŸ’° Prepaid Offer: â‚¹${base} â€“ â‚¹${d._computed.prepaidDiscount} discount = â‚¹${prepaidAmount}
ğŸšš Estimated Delivery:
â€“ Prepaid: ${d.eta}

ğŸ’µ COD: â‚¹${base} + COD Charges: â‚¹${codInfo.codCharges}
â¡ COD Advance: â‚¹${codAdvance}
â¡ Remaining on Delivery: â‚¹${codRemaining}
ğŸšš Estimated Delivery:
â€“ COD: ${codEta}

ğŸ‘‰ Complete payment soon to confirm your order.
ğŸ’š Team GamesPlanet`;
  const mobile = getCustomerMobile();
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}

</script>

</body>
</html>
