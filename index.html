<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GamesPlanet Final Order Converter (ETA + Distance Final)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 250px; font-size: 14px; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; font-size: 14px; }
    button { padding: 10px 15px; font-size: 14px; margin: 4px; cursor: pointer; }
  </style>
</head>
<body>

<h2>GamesPlanet Final Order Converter (ETA + Distance Final)</h2>

<textarea id="input" placeholder="Paste order details here"></textarea><br><br>

<button onclick="convert()">Convert</button>
<button onclick="copyAll()">Copy All</button>
<button onclick="sendThanks()">Send Thanks</button>
<button onclick="sendAbandonedCart()">Send Abandoned Cart WhatsApp</button>

<pre id="output"></pre>

<script>
// Load pincode data
let pincodeLatLng = {};
fetch('pincode_data.json')
  .then(response => response.json())
  .then(data => { pincodeLatLng = data; })
  .catch(error => console.log("Error loading pincode data:", error));

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function estimateDeliveryByDistance(distance) {
  if (distance <= 30) return "1 day";
  else if (distance <= 60) return "1â€“2 days";
  else if (distance <= 100) return "2â€“3 days";
  else if (distance <= 200) return "3â€“4 days";
  else if (distance <= 500) return "4â€“5 days";
  else if (distance <= 1000) return "4â€“6 days";
  else if (distance <= 1500) return "5â€“7 days";
  else if (distance <= 2000) return "6â€“8 days";
  else if (distance <= 3000) return "6â€“10 days";
  else return "8â€“12 days (sometimes up to 15 days)";
}

function getEstimatedDate(eta, extra = 0) {
  if (!eta.match(/\d/)) return "Not Available";
  let today = new Date();
  let numbers = [...eta.matchAll(/\d+/g)].map(n => parseInt(n[0]));
  if (numbers.length === 1) numbers.push(numbers[0]);
  numbers = numbers.map(n => n + extra);
  let dates = numbers.map(d => {
    let future = new Date(today);
    future.setDate(future.getDate() + d);
    return future.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  });
  return dates.length === 2 ? `${dates[0]} to ${dates[1]}` : dates[0];
}

function convert() {
  let input = document.getElementById("input").value.toLowerCase();

  let orderId = input.match(/#\d{5,}/)?.[0] || "Not found";
  let name = input.match(/name\s*\n([^\n]+)/i)?.[1].trim() || "Customer";
  let mobile = input.match(/mobile\s*\n([^\n]+)/i)?.[1].trim() || "";
  let altMobile = input.match(/alternate mobile number\s*\n([^\n]+)/i)?.[1].trim() || "";
  let email = input.match(/email\s*\n([^\n]+)/i)?.[1].trim() || "";
  let address = input.match(/shipping address\s*\n([^\n]+)/i)?.[1].trim() || "";
  let pincode = input.match(/\b\d{6}\b/)?.[0] || "";
  let basePrice = input.match(/1x\s*â‚¹([\d,]+)/i)?.[1].replace(/,/g,"") || "0";

  let discount = "0";
  if (input.includes("coupon discount")) {
    let d = input.match(/coupon discount[^\n]*\n-â‚¹(\d+)/i);
    discount = d ? d[1] : "0";
  }

  let amountPaid = input.match(/Total\s*PAID\s*â‚¹([\d,]+)/i)?.[1].replace(/,/g,"") || "0";

  let variant = "";
  let variantMatch = input.match(/(?:size|storage|variant|verient)[:\s]*([^\n]+)/i);
  variant = variantMatch ? variantMatch[1].trim().toUpperCase() : "";

  let city = "Unknown", state = "Unknown", distance = "N/A", eta = "N/A", estDate = "Not Available";
  if (pincode in pincodeLatLng) {
    let dest = pincodeLatLng[pincode];
    city = dest.city; state = dest.state;
    distance = haversine(28.8,79.0,dest.lat,dest.lng).toFixed(0);
    eta = estimateDeliveryByDistance(distance);
    estDate = getEstimatedDate(eta);
  }

  let outputText = 
`ðŸŸ¢ Prepaid Order on Dukaan

Order ID: ${orderId}
Name: ${name}
Mobile: ${mobile}
Alt Mobile: ${altMobile}
Email: ${email}

Address: ${address}
Pincode: ${pincode}
State: ${state}
District/City: ${city}

Product: UNKNOWN
Variant: ${variant}
Base Price: â‚¹${basePrice}
Discount Applied: â‚¹${discount}
Amount Paid: â‚¹${amountPaid}
ðŸ“ Distance: ${distance} km
â³ ETA: ${eta}
ðŸ“… Estimated Delivery Date: ${estDate}
ðŸ“ Delivery timeline is based on past experience. Sometimes it may delay by 1â€“3 days due to unforeseen circumstances.`;

  document.getElementById("output").textContent = outputText;
}

function copyAll() {
  navigator.clipboard.writeText(document.getElementById("output").textContent).then(() => alert("Copied!"));
}

function sendThanks() {
  let o = document.getElementById("output").textContent;
  let name = o.match(/Name: ([^\n]+)/)?.[1] || "Customer";
  let orderId = o.match(/Order ID: ([^\n]+)/)?.[1] || "Not found";
  let product = o.match(/Product: ([^\n]+)/)?.[1].trim() || "";
  let variant = o.match(/Variant: ([^\n]+)/)?.[1].trim() || "";
  let pincode = o.match(/Pincode: ([^\n]+)/)?.[1] || "";
  let distance = o.match(/Distance: ([^\n]+)/)?.[1] || "";
  let eta = o.match(/ETA: ([^\n]+)/)?.[1] || "";
  let estDate = getEstimatedDate(eta);

  let msg = encodeURIComponent(
`ðŸŒŸ GamesPlanet
ðŸ™ Hello ${name} ji, thank you for your order ${orderId}.
ðŸ“¦ Product: ${product} (${variant})
ðŸ“ Pincode: ${pincode} | ðŸ“ Distance: ${distance}
â³ ETA: ${eta}
ðŸ“… Estimated Delivery Date: ${estDate}
ðŸšš Your order will be shipped soon between 8PMâ€“10PM.
ðŸ”— Tracking will update on our website after dispatch.
ðŸ–¼ï¸ On request, we can send *parcel pic & tracking number* here on WhatsApp.
ðŸ“ Delivery timeline is based on past experience. Sometimes it may delay by 1â€“3 days due to unforeseen circumstances.
ðŸ’š Team GamesPlanet`);

  let mobile = document.getElementById("input").value.match(/\+91[-\s]?[0-9]{10}/)?.[0].replace(/\s|-/g,"") || "";
  if(mobile) window.open(`https://wa.me/${mobile}?text=${msg}`, "_blank");
  else alert("Customer mobile number not found.");
}

function sendAbandonedCart() {
  let o = document.getElementById("output").textContent;
  let name = o.match(/Name: ([^\n]+)/)?.[1] || "Customer";
  let orderId = o.match(/Order ID: ([^\n]+)/)?.[1] || "Not found";
  let product = o.match(/Product: ([^\n]+)/)?.[1].trim() || "";
  let variant = o.match(/Variant: ([^\n]+)/)?.[1].trim() || "";
  let city = o.match(/District\/City: ([^\n]+)/)?.[1] || "";
  let distance = o.match(/Distance: ([^\n]+)/)?.[1] || "";
  let eta = o.match(/ETA: ([^\n]+)/)?.[1] || "few days";
  let prepaidDate = getEstimatedDate(eta);
  let codDate = getEstimatedDate(eta, 2);

  let basePrice = parseInt(o.match(/Base Price: â‚¹([\d,]+)/)?.[1].replace(/,/g, '') || "0");
  let discount = parseInt(o.match(/Discount Applied: â‚¹([\d,]+)/)?.[1].replace(/,/g, '') || "0");
  let prepaidAmount = basePrice - discount;

  let codAvailable = basePrice >= 1000;
  let codCharge = (basePrice < 1500) ? 99 : 0;
  let codTotal = basePrice + codCharge;
  let codAdvance = Math.max(500, Math.round(codTotal * 0.10));
  let codRemaining = codTotal - codAdvance;

  let codInfo = codAvailable
    ? `ðŸ’µ COD: â‚¹${basePrice} + â‚¹${codCharge} COD Charges = â‚¹${codTotal}
âž¡ COD Advance: â‚¹${codAdvance}
âž¡ Remaining on Delivery: â‚¹${codRemaining}
ðŸ“… Estimated Delivery Date (COD): ${codDate}`
    : `ðŸš« COD not available below â‚¹1000`;

  let msg = encodeURIComponent(
`ðŸŒŸ GamesPlanet

ðŸ™ Hello ${name} ji,

ðŸ“ Incomplete Order Details:
â€“ Order ID: ${orderId}
â€“ Product: ${product} (${variant})
â€“ Base Price: â‚¹${basePrice}
ðŸ“ City: ${city}
ðŸ“ Distance: ${distance}

ðŸ’° Prepaid Offer: â‚¹${basePrice} â€“ â‚¹${discount} discount = â‚¹${prepaidAmount}
â³ ETA: ${eta}
ðŸ“… Estimated Delivery Date (Prepaid): ${prepaidDate}

${codInfo}

ðŸ“ Delivery timeline is based on past experience. Sometimes it may delay by 1â€“3 days due to unforeseen circumstances.
ðŸ‘‰ Complete payment soon to confirm your order.
ðŸ’š Team GamesPlanet`);

  let mobile = document.getElementById("input").value.match(/\+91[-\s]?[0-9]{10}/)?.[0].replace(/\s|-/g,"") || "";
  if(mobile) window.open(`https://wa.me/${mobile}?text=${msg}`, "_blank");
  else alert("Customer mobile number not found.");
}
</script>

</body>
</html>
