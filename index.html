<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GamesPlanet ‚Äî No Quick-Buy Link</title>
  <style>
    body{font-family:Arial, Helvetica, sans-serif; max-width:1000px; margin:18px auto; padding:12px;}
    textarea{width:100%;height:300px;padding:10px;font-size:14px;box-sizing:border-box;border-radius:6px;border:1px solid #ddd;}
    pre{background:#f6f7f9;padding:12px;border-radius:8px;border:1px solid #e6e6e6;white-space:pre-wrap;font-size:14px;}
    button{padding:8px 12px;margin:6px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    .hr{height:1px;background:#e6e6e6;margin:12px 0;}
  </style>
</head>
<body>

<h2>GamesPlanet ‚Äî Abandoned Cart (No Quick-Buy Link)</h2>

<textarea id="input" placeholder="Paste raw order text here... (include Mobile: 9876543210 or +91 9876543210)."></textarea>

<div class="row">
  <button onclick="selectAll()">Select All</button>
  <button onclick="clearText()">Clear</button>
  <button onclick="convert()">Convert (Preview)</button>
  <button onclick="copyAll()">Copy Output</button>
</div>

<div class="row">
  <button onclick="sendPrepaidToCustomer()">Send Prepaid ‚Üí Customer</button>
  <button onclick="sendPrepaidToOwn()">Send Prepaid ‚Üí Own</button>
  <button onclick="sendCodToCustomer()">Send COD ‚Üí Customer</button>
  <button onclick="sendCodToOwn()">Send COD ‚Üí Own</button>
</div>

<div class="row">
  <button onclick="sendThanks()">Send Thanks</button>
  <button onclick="sendAbandonedCart()">Send Abandoned Cart (detailed ‚Üí customer only)</button>
</div>

<div class="hr"></div>
<pre id="output"></pre>

<script>
/* ================= load pincode data (optional) ================= */
let pincodeLatLng = {};
fetch('pincode_data.json')
  .then(r => r.json())
  .then(d => { pincodeLatLng = d; })
  .catch(()=>{ /* OK if missing */ });

/* ================ Product tokens (restored/expanded) ================ */
const products = [
  "Super Mini U Box MD 16bit Sega ","aoko game stick","Aoko Game Stick","AOKO GAME STICK","aoko game stick v1","Aoko Game Stick V1","AOKO GAME STICK V1",
  "black hawk","Black Hawk","BLACK HAWK","black hawk v1","Black Hawk V1","BLACK HAWK V1",
  "fmcb","FMCB","fmcb + usb","FMCB + USB","fmcb + usb optional","FMCB + USB Optional","fmcb + usb top","FMCB + USB Top",
  "gamestick lite","Gamestick Lite","GAMESTICK LITE","gamestick pro","Gamestick Pro","GAMESTICK PRO","game stick gd10","Game Stick GD10","GAME STICK GD10",
  "gamestick blaster","Gamestick Blaster","GAMESTICK BLASTER","game box g10","Game Box G10","G10","G10V3","G11 Pro","M88","M99",
  "gs5","k8","m15 pro","m22","m33","m44","m55","m66","m77","m88","m99","m222","m333","m444","m555","m666","m777","m888","m999",
  "nintendo switch","nintendo switch oled","nintendo wii","nintendo wii u","nintendo ds","nintendo 3ds",
  "ps2","ps3","psp","xbox","xbox 360","xbox one","xbox series x",
  "sd card","sdcard","tf card","micro sd","memory card","64gb","128gb","256gb","500gb","1tb",
  "gameboy","retro console","retro gaming","gamebox","game box","gamebox g10",
  "usb","pendrive","pendrive combo","combo","usb combo","usb hdd","usb ssd","hdd","ssd","pd","pd usb","pd charger","pd power","pd cable","pd pd",
  "fmcb for ps2 opl","ps2 fmcb","usb combo pack","usb ssd combo","pendrive 64gb","pendrive 128gb"
];

/* ================= basic UI helpers ================= */
function selectAll(){ const t=document.getElementById('input'); t.focus(); t.select(); }
function clearText(){ document.getElementById('input').value=''; document.getElementById('output').textContent=''; }
function copyAll(){ navigator.clipboard.writeText(document.getElementById('output').textContent).then(()=>alert('Copied!')).catch(()=>alert('Copy failed')); }
function encodeForWA(t){ return encodeURIComponent(t); }
function waOpen(number, msg){ window.open(`https://wa.me/${number}?text=${encodeForWA(msg)}`, '_blank'); }

/* Sales number constant (kept for internal use only) */
const SALES_NUMBER = '917983624797';

/* ================== Robust mobile extraction (primary + alt) ================== */
function getCustomerMobileFromRaw(raw){
  if(!raw) return '';
  // first, explicit labeled mobile lines
  let m = raw.match(/(?:^|\n)\s*(?:mobile|phone|mobl|mob)[:\s]*([+\d\-\s()]{6,})/i)?.[1];
  if(m){
    m = m.replace(/\D/g,'').replace(/^0+/,'');

    if(m.length === 12 && m.startsWith('91')) return m;
    if(m.length === 10) return m;
    if(m.length > 10) return m.slice(-10);
  }
  // fallback: any 10-digit group
  const any = raw.match(/(?:\+?91[-\s]?)?(\d{10})/);
  if(any && any[1]) return any[1];
  return '';
}

function extractAltMobile(raw, primary){
  // 1) try labeled alternate patterns
  let altMatch = raw.match(/(?:^|\n)\s*(?:alt(?:ernate)?(?: mobile| number)?|other mobile|alt\. mobile|alt mobile|alternate number|altno|alt no|alternate mobile number)[:\s]*([+\d\-\s()]{6,})/i);
  if(altMatch && altMatch[1]){
    let a = altMatch[1].replace(/\D/g,'').replace(/^0+/,'');

    if(a.length === 12 && a.startsWith('91')) return a;
    if(a.length === 10) return a;
    if(a.length > 10) return a.slice(-10);
  }
  // 2) fallback: choose last 10-digit not equal to primary
  const all = [];
  const re = /(?:\+?91[-\s]?)?(\d{10})/g;
  let mm;
  while((mm = re.exec(raw)) !== null){
    all.push(mm[1]);
  }
  if(all.length === 0) return '';
  const primaryNorm = (primary||'').toString().replace(/\D/g,'').replace(/^0+/,'');

  const candidates = all.filter(n => n !== primaryNorm);
  if(candidates.length) return candidates[candidates.length - 1];
  return '';
}

/* ================= haversine & ETA helpers ================= */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function estimateDeliveryByDistance(distance) {
  const d = Number(distance);
  if (isNaN(d)) return "N/A";
  if (d <= 30) return "1 day";
  if (d <= 60) return "1-2 days";
  if (d <= 100) return "2-3 days";
  if (d <= 200) return "3-4 days";
  if (d <= 500) return "4-5 days";
  if (d <= 1000) return "4-6 days";
  if (d <= 1500) return "5‚Äì7 days";
  if (d <= 2000) return "6‚Äì8 days";
  if (d <= 3000) return "6‚Äì10 days";
  return "8‚Äì12 days (sometimes up to 15 days)";
}

function parseEtaRange(etaStr){
  if(!etaStr || etaStr === "N/A") return null;
  const nums = (etaStr.match(/\d+/g)||[]).map(n=>parseInt(n,10));
  if(nums.length === 1) return {min: nums[0], max: nums[0]};
  if(nums.length >= 2) return {min: nums[0], max: nums[1]};
  return null;
}
function bumpEtaRangeString(etaStr, addMin=2, addMax=3){
  const r = parseEtaRange(etaStr); if(!r) return etaStr;
  const min = r.min + addMin; const max = r.max + addMax;
  return (min===max) ? `${min} days` : `${min}-${max} days`;
}
function todayStrOffset(days){
  const d = new Date(); d.setDate(d.getDate()+days);
  return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
}
function estimatedWindowFromEta(etaStr){
  const r = parseEtaRange(etaStr); if(!r) return etaStr || "";
  const start = todayStrOffset(r.min); const end = todayStrOffset(r.max);
  return (r.min===r.max) ? `${start}` : `${start} to ${end}`;
}

/* ================= Business rules: COD & Prepaid discounts ================= */

/* COD charges rule */
function computeCodCharges(basePrice){
  basePrice = Number(basePrice) || 0;
  if(basePrice > 0 && basePrice < 1499) return 99;
  return 0;
}

/* COD amounts (M88 special-case) */
function computeCodAmountsForProduct(d){
  let base = Number(d.basePrice) || 0;
  const prod = (d.detectedProduct||'').toLowerCase();
  if(prod.indexOf('m88') !== -1) base = 7499;
  const codCharges = computeCodCharges(base);
  const advance = Math.max(500, Math.round(base * 0.10));
  const rest = Math.max(0, (base + codCharges) - advance);
  return { advance, rest, codCharges, codBase: base };
}

/* Prepaid discount rules (5% tokens, M88 special, gamestick sizes) */
function computePrepaidDiscount(d, paymentMethod){
  const base = Number(d.basePrice) || 0;
  if(!base || base <= 0) return 0;
  if(paymentMethod !== 'wa_qr') return 0;
  const prod = (d.detectedProduct || '').toLowerCase();
  const variant = (d.variant || '').toLowerCase();
  const notes = ((d.notes || '') + ' ' + (d.extra || '')).toLowerCase();
  const hay = prod + ' ' + variant + ' ' + notes;

  if(prod.indexOf('m88') !== -1) return Math.max(0, base - 6699);

  const fivePercentTokens = ['fmcb','ps2','usb','pendrive','pd','ssd','combo','500gb'];
  if(fivePercentTokens.some(tok => hay.indexOf(tok) !== -1)) return Math.round(base * 0.05);

  if(/gamestick|game stick|gamebox|sd card|sdcard|sd-card/.test(hay) || /64\b|128\b|256\b/.test(variant + ' ' + prod)){
    if(variant.indexOf('64') !== -1 || prod.indexOf('64gb') !== -1) return 200;
    if(variant.indexOf('128') !== -1 || prod.indexOf('128gb') !== -1) return 300;
    if(variant.indexOf('256') !== -1 || prod.indexOf('256gb') !== -1) return 500;
    return 0;
  }

  return 0;
}

/* ================= Parsing input ================= */
function parseInput(){
  const raw = document.getElementById('input').value || '';
  const lower = raw.toLowerCase();

  // order id
  let orderId = raw.match(/#\s*\d{5,}/)?.[0] || '';
  if(!orderId){
    const firstNonEmpty = raw.split('\n').map(s=>s.trim()).find(s=>s);
    const m = firstNonEmpty && firstNonEmpty.match(/\d{6,}/);
    if(m) orderId = '#'+m[0];
  }
  if(!orderId) orderId = 'Not found';

  // name
  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || 'Customer').trim();

  // primary mobile raw
  const mobileRaw = (raw.match(/mobile\s*[:\n]\s*([+\d\-\s()]{6,})/i)?.[1] || raw.match(/(?:\+?91[-\s]?)?\d{10}/)?.[0] || '').trim();

  // alt mobile
  let altMobile = extractAltMobile(raw, mobileRaw);

  // email
  const email = (raw.match(/email\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();

  // address
  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:Payments|Payment|Additional|Customer|Mobile|Email|$))/i)?.[1] ||
                   raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim().replace(/\s+/g,' ');

  let landmark = (raw.match(/landmark\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  if(!landmark){
    const near = address && address.match(/\b(?:near|opp(?:osite)?|behind|beside)\b[^,;|]+/i);
    if(near) landmark = near[0].trim();
  }

  const postOffice = (raw.match(/post\s*office\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || '').trim();

  // correct multi-product base price = Subtotal
const basePrice = (
  raw.match(/Subtotal[^\d]+([\d.,]+)/i)?.[1] ||
  raw.match(/Total[^\d]+([\d.,]+)/i)?.[1] ||
  '0'
).replace(/,/g,'').trim();


  let discount = '0';
  const couponLine = raw.match(/coupon\s*discount.*?(-‚Çπ\s*[\d,]+)/i);
  if(couponLine) discount = couponLine[1].replace(/[^\d]/g,'');
  else{
    const d2 = raw.match(/discount\s*applied\s*[:‚Çπ\s-]*([\d,]+)/i);
    if(d2) discount = d2[1].replace(/,/g,'');
  }

  const amountPaid = ((raw.match(/total\s*paid\s*[:‚Çπ\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/\bpaid\b\s*[:‚Çπ\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/amount\s*paid\s*[:‚Çπ\s]*([\d,]+)/i)?.[1] || '0').replace(/,/g,'')).trim();

  // detect product
  let detectedProduct = 'Unknown Product';

  /* ================= MULTI-PRODUCT SUPPORT ADDED ================= */
  let productItems = [];
  {
    const lines = raw.split(/\n+/);
    let i = 0;

    while(i < lines.length){
      const line = lines[i].trim();
      const qtyLine = (lines[i+1] || '').trim();
      const priceLine = (lines[i+2] || '').trim();

      if(
        line.length > 2 &&
        qtyLine.match(/^\d+x\s*‚Çπ?/i) &&
        priceLine.match(/‚Çπ/)
      ){
        const qty = qtyLine.match(/(\d+)x/)?.[1] || '1';
        const price = priceLine.replace(/[^0-9]/g,'');
        productItems.push({ name: line, qty, price });
        i += 3;
        continue;
      }
      i++;
    }
  }

  if(productItems.length > 0){
    detectedProduct = productItems.map(p => `${p.name} x${p.qty}`).join(' + ');
  }

  const afterItem = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItem && afterItem.length>2) detectedProduct = afterItem;
  if(detectedProduct === 'Unknown Product'){
    for(const p of products.sort((a,b)=>b.length - a.length)){
      if(lower.includes(p.toLowerCase())) { detectedProduct = p; break; }
    }
  }

  // variant detection
  let variant = '';
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim();
  else {
    const vInName = (detectedProduct||'').match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1].toUpperCase();
  }

  // ETA/distance via pincode
  let city = 'Unknown', state = 'Unknown', distance = 'N/A', eta = 'N/A';
  if(pincode && pincodeLatLng[pincode]){
    const dest = pincodeLatLng[pincode];
    city = dest.city || 'Unknown';
    state = dest.state || 'Unknown';
    distance = haversine(28.8,79.0,dest.lat,dest.lng).toFixed(0);
    eta = estimateDeliveryByDistance(distance);
  }

  // normalize mobile display
  let mobileDisplay = mobileRaw;
  if(mobileDisplay && mobileDisplay.indexOf('+') === -1 && !mobileDisplay.startsWith('0') && mobileDisplay.length === 10) {
    mobileDisplay = '+91-' + mobileDisplay;
  }

  return {
    orderId, name, mobile: mobileDisplay, mobileRaw, altMobile, email,
    address, landmark, postOffice, pincode,
    basePrice, discount, amountPaid,
    detectedProduct, variant,
    city, state, distance, eta
  };
}

/* ================== Message builders ================== */
function buildPrepaidMessage(d){
  const estWindow = d.eta && d.eta !== "N/A" ? estimatedWindowFromEta(d.eta) : "";
  const paymentMethod = 'wa_qr';
  const prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - prepaidDiscount);
  d._computed = d._computed || {};
  d._computed.prepaidDiscount = prepaidDiscount;
  d._computed.prepaidAmount = prepaidAmount;

  return `üü¢ Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile || ''}
Alt Mobile: ${d.altMobile || ''}
Email: ${d.email || ''}
Address: ${d.address || ''}
Landmark: ${d.landmark || ''}
Pincode: ${d.pincode || ''}
State: ${d.state || ''}
District/City: ${d.city || ''}
Post office: ${d.postOffice || ''}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ‚Çπ${d.basePrice}
Discount Applied: ‚Çπ${d._computed.prepaidDiscount}
Amount Paid: ‚Çπ${d._computed.prepaidAmount}

üìè Distance: ${d.distance} km
‚è≥ Prepaid Order ETA: ${d.eta}
üìÖ Estimated Delivery: ${estWindow}`;
}

function buildCodMessage(d){
  const codInfo = computeCodAmountsForProduct(d);
  d._computed = d._computed || {};
  d._computed.codCharges = codInfo.codCharges;
  d._computed.codAdvance = codInfo.advance;
  d._computed.codRestOnDelivery = codInfo.rest;
  d._computed.codBase = codInfo.codBase;

  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;
  const estCodWindow = codEta && codEta !== "N/A" ? estimatedWindowFromEta(codEta) : "";

  return `üî¥ COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile || ''}
Alt Mobile: ${d.altMobile || ''}
Email: ${d.email || ''}
Address: ${d.address || ''}
Landmark: ${d.landmark || ''}
Pincode: ${d.pincode || ''}
State: ${d.state || ''}
District/City: ${d.city || ''}
Post office: ${d.postOffice || ''}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ‚Çπ${d._computed.codBase}
COD Charges: ‚Çπ${d._computed.codCharges}
Amount Paid (Advance): ‚Çπ${d._computed.codAdvance}
Rest on Delivery: ‚Çπ${d._computed.codRestOnDelivery}

üìè Distance: ${d.distance} km
‚è≥ COD Order ETA: ${codEta}
üìÖ Estimated Delivery: ${estCodWindow}`;
}

/* Abandoned-cart detailed message (customer only) */
function buildAbandonedCartCustomerMsg(d){
  d._computed = d._computed || {};
  const paymentMethod = 'wa_qr';
  d._computed.prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - d._computed.prepaidDiscount);
  const codInfo = computeCodAmountsForProduct(d);
  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta,2,3) : d.eta;
  const estWindow = d.eta && d.eta !== "N/A" ? estimatedWindowFromEta(d.eta) : "";

  return `üåü GamesPlanet

üôè Hello ${d.name} ji,

üìù Incomplete Order Details: 
‚Äì Order ID: ${d.orderId}
‚Äì Product: ${d.detectedProduct} (${d.variant})
‚Äì Base Price: ‚Çπ${d.basePrice}
üìç City: ${d.city}
üìè Distance: ${d.distance} km

üí∞ Prepaid Offer: ‚Çπ${d.basePrice} ‚Äì ‚Çπ${d._computed.prepaidDiscount} discount = ‚Çπ${prepaidAmount}
üöö Estimated Delivery (Prepaid): ${d.eta} ‚Äî ${estWindow}

üíµ COD: ‚Çπ${codInfo.codBase} + COD Charges: ‚Çπ${codInfo.codCharges}
‚û° COD Advance: ‚Çπ${codInfo.advance}
‚û° Remaining on Delivery: ‚Çπ${codInfo.rest}
üöö Estimated Delivery (COD): ${codEta}

üëâ Complete payment soon to confirm your order.

üíö Team GamesPlanet`;
}

/* ================= Actions / Senders ================= */
function convert(){
  const d = parseInput();
  const prepaid = buildPrepaidMessage(d);
  const cod = buildCodMessage(d);
  document.getElementById('output').textContent = prepaid + "\n\n" + cod;
}

/* Safe senders to customer (normalize to 91XXXXXXXXXX) */
function sendPrepaidToCustomer(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  const raw = d.mobileRaw || '';
  if(!raw){ alert('Customer mobile not found. Include Mobile: 9876543210 or +91 9876543210 in input.'); return; }
  const to = raw.replace(/\D/g,'').replace(/^0+/,'');
  const to91 = to.startsWith('91') ? to : ('91' + to);
  waOpen(to91, msg);
}
function sendPrepaidToOwn(){ const d = parseInput(); waOpen(SALES_NUMBER, buildPrepaidMessage(d)); }

function sendCodToCustomer(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  const raw = d.mobileRaw || '';
  if(!raw){ alert('Customer mobile not found.'); return; }
  const to = raw.replace(/\D/g,'').replace(/^0+/,'');
  const to91 = to.startsWith('91') ? to : ('91' + to);
  waOpen(to91, msg);
}
function sendCodToOwn(){ const d = parseInput(); waOpen(SALES_NUMBER, buildCodMessage(d)); }

function sendThanks(){
  const d = parseInput();
  const msg = `üåü GamesPlanet
üôè Hello ${d.name} ji, thank you for your order ${d.orderId}.
üì¶ Product: ${d.detectedProduct} (${d.variant})
üìç Pincode: ${d.pincode} | üìè Distance: ${d.distance} km
‚è≥ Estimated Delivery: ${d.eta}
üöö Your order will be shipped soon between 8PM‚Äì10PM.
üîó Tracking will update on our website after dispatch.
üñºÔ∏è On request, we can send *parcel pic & tracking number* here on WhatsApp.
üíö Team GamesPlanet`;
  const raw = d.mobileRaw || '';
  if(!raw){ alert('Customer mobile not found.'); return; }
  const to = raw.replace(/\D/g,'').replace(/^0+/,'');
  const to91 = to.startsWith('91') ? to : ('91' + to);
  waOpen(to91, msg);
}

/* ================= Abandoned Cart (NO quick-buy link) =================
   Sends ONLY the detailed abandoned-cart message to customer (if found).
   No second message, no sales link. Preview shown in output.
======================================================================= */
function sendAbandonedCart(){
  const d = parseInput();
  const raw = d.mobileRaw || '';
  const custMsg = buildAbandonedCartCustomerMsg(d);

  if(raw){
    const to = raw.replace(/\D/g,'').replace(/^0+/,'');
    const to91 = to.startsWith('91') ? to : ('91' + to);
    // send only detailed message to customer
    waOpen(to91, custMsg);
    // preview
    document.getElementById('output').textContent = custMsg;
  } else {
    alert('Customer mobile not found ‚Äî cannot send abandoned-cart to customer.');
    document.getElementById('output').textContent = "Customer mobile not found.\nPreview:\n\n" + custMsg;
  }
}

</script>

</body>
</html>
