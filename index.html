<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GamesPlanet — Final Patched (ETA / Distance / Abandon fix)</title>
  <style>
    body{font-family:Arial, Helvetica, sans-serif; max-width:1000px; margin:18px auto; padding:12px;}
    textarea{width:100%;height:280px;padding:10px;font-size:14px;box-sizing:border-box;border-radius:6px;border:1px solid #ddd;}
    pre{background:#f6f7f9;padding:12px;border-radius:8px;border:1px solid #e6e6e6;white-space:pre-wrap;font-size:14px;}
    button{padding:8px 12px;margin:6px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    .hr{height:1px;background:#e6e6e6;margin:12px 0;}
  </style>
</head>
<body>

<h2>GamesPlanet — Final Patched (ETA/Distance + Abandon Link)</h2>

<textarea id="input" placeholder="Paste raw order text here... (include Mobile: 9876543210 or +91 9876543210)"></textarea>

<div class="row">
  <button onclick="selectAll()">Select All</button>
  <button onclick="clearText()">Clear</button>
  <button onclick="convert()">Convert (Preview)</button>
  <button onclick="copyAll()">Copy Output</button>
</div>

<div class="row">
  <button onclick="sendPrepaidToCustomer()">Send Prepaid → Customer</button>
  <button onclick="sendPrepaidToOwn()">Send Prepaid → Own</button>
  <button onclick="sendCodToCustomer()">Send COD → Customer</button>
  <button onclick="sendCodToOwn()">Send COD → Own</button>
</div>

<div class="row">
  <button onclick="sendThanks()">Send Thanks</button>
  <button onclick="sendAbandonedCart()">Send Abandoned Cart (detailed → customer + quick-link to same customer)</button>
  <button onclick="quickBuyToSales()">Quick Buy → Sales (test)</button>
</div>

<div class="hr"></div>
<pre id="output"></pre>

<script>
/* ---------------- load pincode data (if available) ---------------- */
let pincodeLatLng = {};
fetch('pincode_data.json')
  .then(r => r.json())
  .then(d => { pincodeLatLng = d; })
  .catch(()=>{ /* ok if not present */ });

/* ---------------- original product/variant lists (restored) -------------- */
const products = [
  "Super Mini U Box MD 16bit Sega ","aoko game stick","Aoko Game Stick","AOKO GAME STICK","aoko game stick v1","Aoko Game Stick V1","AOKO GAME STICK V1",
  "black hawk","Black Hawk","BLACK HAWK","black hawk v1","Black Hawk V1","BLACK HAWK V1",
  "fmcb","FMCB","fmcb + usb","FMCB + USB","fmcb + usb optional","FMCB + USB Optional","fmcb + usb top","FMCB + USB Top",
  "gamestick lite","Gamestick Lite","GAMESTICK LITE","gamestick pro","Gamestick Pro","GAMESTICK PRO","game stick gd10","Game Stick GD10","GAME STICK GD10",
  "gamestick blaster","Gamestick Blaster","GAMESTICK BLASTER","game box g10","Game Box G10","G10","G10V3","G11 Pro","M88","M99",
  "gs5","k8","m15 pro","m22","m33","m44","m55","m66","m77","m88","m99","m222","m333","m444","m555","m666","m777","m888","m999",
  "nintendo switch","nintendo switch oled","nintendo wii","nintendo wii u","nintendo ds","nintendo 3ds",
  "ps2","ps3","psp","xbox","xbox 360","xbox one","xbox series x",
  "sd card","sdcard","tf card","micro sd","memory card","64gb","128gb","256gb","500gb","1tb",
  "gameboy","retro console","retro gaming","gamebox","game box","gamebox g10",
  "usb","pendrive","pendrive combo","combo","usb combo","usb hdd","usb ssd","hdd","ssd","pd"
];
// Note: list restored to include many variants (case-insensitive matching later)

/* ---------------- basic helpers ---------------- */
function selectAll(){ const t=document.getElementById('input'); t.focus(); t.select(); }
function clearText(){ document.getElementById('input').value=''; document.getElementById('output').textContent='';}
function copyAll(){ navigator.clipboard.writeText(document.getElementById('output').textContent).then(()=>alert('Copied!')).catch(()=>alert('Copy failed')); }
function encodeForWA(t){ return encodeURIComponent(t); }
function waOpen(number, msg){ window.open(`https://wa.me/${number}?text=${encodeForWA(msg)}`, '_blank'); }
const SALES_NUMBER = '917983624797'; // sales with country code
const SALES_NUMBER_RAW = '7983624797'; // raw sales (no country code) for display

/* Robust customer mobile extraction */
function getCustomerMobile() {
  const raw = (document.getElementById('input').value || '').toString();
  // Try explicit label line first
  let m = raw.match(/(?:^|\n)\s*(?:mobile|phone|mobl|mob)[:\s]*([+\d\-\s()]{6,})/i)?.[1];
  if (m) {
    m = m.replace(/\D/g,'').replace(/^0+/,'');
    if (m.length === 12 && m.startsWith('91')) return m; // 91XXXXXXXXXX
    if (m.length === 10) return m; // XXXXXXXXXX
    if (m.length > 10) return m.slice(-10);
  }
  // fallback - any 10-digit occurrence
  const any = raw.match(/(?:\+?91[-\s]?)?(\d{10})/);
  if (any && any[1]) return any[1];
  return '';
}

/* ---------- haversine & ETA helpers ---------- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function estimateDeliveryByDistance(distance) {
  const d = Number(distance);
  if (isNaN(d)) return "N/A";
  if (d <= 30) return "1 day";
  if (d <= 60) return "1-2 days";
  if (d <= 100) return "2-3 days";
  if (d <= 200) return "3-4 days";
  if (d <= 500) return "4-5 days";
  if (d <= 1000) return "4-6 days";
  if (d <= 1500) return "5–7 days";
  if (d <= 2000) return "6–8 days";
  if (d <= 3000) return "6–10 days";
  return "8–12 days (sometimes up to 15 days)";
}
function parseEtaRange(etaStr){
  if(!etaStr || etaStr === "N/A") return null;
  const nums = (etaStr.match(/\d+/g)||[]).map(n=>parseInt(n,10));
  if(nums.length === 1) return {min: nums[0], max: nums[0]};
  if(nums.length >= 2) return {min: nums[0], max: nums[1]};
  return null;
}
function bumpEtaRangeString(etaStr, addMin=2, addMax=3){
  const r = parseEtaRange(etaStr); if(!r) return etaStr;
  const min = r.min + addMin; const max = r.max + addMax;
  return (min===max) ? `${min} days` : `${min}-${max} days`;
}
function todayStrOffset(days){
  const d = new Date(); d.setDate(d.getDate()+days);
  return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
}
function estimatedWindowFromEta(etaStr){
  const r = parseEtaRange(etaStr); if(!r) return etaStr || "";
  const start = todayStrOffset(r.min); const end = todayStrOffset(r.max);
  return (r.min===r.max) ? `${start}` : `${start} to ${end}`;
}

/* ---------------- Business rules (COD / Prepaid discounts) --------------- */
/* COD charges rule: base >0 && <1499 => 99; else 0 */
function computeCodCharges(basePrice){
  basePrice = Number(basePrice)||0;
  if(basePrice > 0 && basePrice < 1499) return 99;
  return 0;
}

/* COD amounts (M88 special-case: COD base fixed to 7499) */
function computeCodAmountsForProduct(d){
  let base = Number(d.basePrice)||0;
  const prod = (d.detectedProduct||'').toLowerCase();
  if(prod.indexOf('m88') !== -1) base = 7499;
  const codCharges = computeCodCharges(base);
  const advance = Math.max(500, Math.round(base * 0.10)); // min 500 or 10%
  const rest = Math.max(0, (base + codCharges) - advance);
  return { advance, rest, codCharges, codBase: base };
}

/* Prepaid discount rules (only when paymentMethod === 'wa_qr' — we force this for final calc)
   - M88 prepaid final price 6699 (discount = base - 6699)
   - FMCB/PS2 + usb/hdd/pd/ssd/combo/pendrive/500gb => 5%
   - gamestick / sd card => fixed discounts for 64/128/256
*/
function computePrepaidDiscount(d, paymentMethod){
  const base = Number(d.basePrice)||0;
  if(!base || base <= 0) return 0;
  if(paymentMethod !== 'wa_qr') return 0;
  const prod = (d.detectedProduct||'').toLowerCase();
  const variant = (d.variant||'').toLowerCase();
  const notes = ((d.notes||'') + ' ' + (d.extra||'')).toLowerCase();
  const containsAny = (s, arr) => arr.some(tok => s.indexOf(tok) !== -1);

  if(prod.indexOf('m88') !== -1){
    return Math.max(0, base - 6699);
  }

  if( (prod.indexOf('fmcb') !== -1 || prod.indexOf('ps2') !== -1)
      && containsAny(variant + ' ' + notes, ['usb','hdd','pd','ssd','combo','pendrive','500gb']) ){
    return Math.round(base * 0.05);
  }

  if( containsAny(prod, ['gamestick','game stick','gamebox','sd card','sdcard']) || containsAny(variant, ['64','128','256']) ){
    if(variant.indexOf('64') !== -1 || prod.indexOf('64gb') !== -1) return 200;
    if(variant.indexOf('128') !== -1 || prod.indexOf('128gb') !== -1) return 300;
    if(variant.indexOf('256') !== -1 || prod.indexOf('256gb') !== -1) return 500;
    return 0;
  }

  return 0;
}

/* ---------------------- Parsing input ---------------------- */
function parseInput(){
  const raw = document.getElementById('input').value || '';
  const inputLower = raw.toLowerCase();

  // order id
  let orderId = raw.match(/#\s*\d{5,}/)?.[0] || '';
  if(!orderId){
    const firstNonEmpty = raw.split('\n').map(s=>s.trim()).find(s=>s);
    const m = firstNonEmpty && firstNonEmpty.match(/\d{6,}/);
    if(m) orderId = '#'+m[0];
  }
  if(!orderId) orderId = 'Not found';

  // name / mobile / alt / email
  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || 'Customer').trim();
  const mobile = (raw.match(/mobile\s*[:\n]\s*([+\d\-\s]{6,})/i)?.[1] || raw.match(/(?:\+?91[-\s]?)?\d{10}/)?.[0] || '').trim();
  const altMobile = (raw.match(/alt(?:ernate)?\s*mobile\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  const email = (raw.match(/email\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();

  // address block
  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:Payments|Payment|Additional|Customer|Mobile|Email|$))/i)?.[1] ||
                   raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim().replace(/\s+/g,' ');

  let landmark = (raw.match(/landmark\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  if(!landmark){
    const near = address && address.match(/\b(?:near|opp(?:osite)?|behind|beside)\b[^,;|]+/i);
    if(near) landmark = near[0].trim();
  }

  const postOffice = (raw.match(/post\s*office\s*[:\n]\s*([^\n]+)/i)?.[1] || '').trim();
  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || '').trim();

  // prices
  const basePrice = ((raw.match(/1x\s*₹?\s*([\d,]+)/i)?.[1] || raw.match(/base\s*price\s*[:₹\s]*([\d,]+)/i)?.[1] || '0').replace(/,/g,'')).trim();

  let discount = '0';
  const couponLine = raw.match(/coupon\s*discount.*?(-₹\s*[\d,]+)/i);
  if(couponLine) discount = couponLine[1].replace(/[^\d]/g,'');
  else {
    const d2 = raw.match(/discount\s*applied\s*[:₹\s-]*([\d,]+)/i);
    if(d2) discount = d2[1].replace(/,/g,'');
  }

  const amountPaid = ((raw.match(/total\s*paid\s*[:₹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/\bpaid\b\s*[:₹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/amount\s*paid\s*[:₹\s]*([\d,]+)/i)?.[1] || '0').replace(/,/g,'')).trim();

  // detect product: prefer explicit "1 item\n<name>" style; else scan product list
  let detectedProduct = 'Unknown Product';
  const afterItemLine = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItemLine && afterItemLine.length > 2) detectedProduct = afterItemLine;
  if(detectedProduct === 'Unknown Product'){
    const lower = inputLower;
    // sort by length to prefer long matches
    for(const p of products.sort((a,b)=>b.length - a.length)){
      if(lower.includes(p.toLowerCase())) { detectedProduct = p; break; }
    }
  }

  // variant detection
  let variant = '';
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim();
  else {
    const vInName = (detectedProduct||'').match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1].toUpperCase();
  }

  // ETA/distance via pincode if available
  let city = 'Unknown', state = 'Unknown', distance = 'N/A', eta = 'N/A';
  if(pincode && pincodeLatLng[pincode]){
    const dest = pincodeLatLng[pincode];
    city = dest.city || 'Unknown';
    state = dest.state || 'Unknown';
    distance = haversine(28.8,79.0,dest.lat,dest.lng).toFixed(0); // origin approx (Rampur) same as original
    eta = estimateDeliveryByDistance(distance);
  }

  return {
    orderId, name, mobile, altMobile, email,
    address, landmark, postOffice, pincode,
    basePrice, discount, amountPaid,
    detectedProduct, variant,
    city, state, distance, eta
  };
}

/* -------------------- Message builders (include ETA/distance) -------------------- */
function buildPrepaidMessage(d){
  const estWindow = d.eta && d.eta !== "N/A" ? estimatedWindowFromEta(d.eta) : "";
  // force prepaid discount rules
  const paymentMethod = 'wa_qr';
  const prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - prepaidDiscount);
  d._computed = d._computed || {};
  d._computed.prepaidDiscount = prepaidDiscount;
  d._computed.prepaidAmount = prepaidAmount;

  return `🟢 Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ₹${d.basePrice}
Discount Applied: ₹${d._computed.prepaidDiscount}
Amount Paid: ₹${d._computed.prepaidAmount}

📏 Distance: ${d.distance} km
⏳ Prepaid Order ETA: ${d.eta}
📅 Estimated Delivery: ${estWindow}`;
}

function buildCodMessage(d){
  const codInfo = computeCodAmountsForProduct(d);
  d._computed = d._computed || {};
  d._computed.codCharges = codInfo.codCharges;
  d._computed.codAdvance = codInfo.advance;
  d._computed.codRestOnDelivery = codInfo.rest;
  d._computed.codBase = codInfo.codBase;

  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;
  const estCodWindow = codEta && codEta !== "N/A" ? estimatedWindowFromEta(codEta) : "";

  return `🔴 COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: ₹${d._computed.codBase}
COD Charges: ₹${d._computed.codCharges}
Amount Paid (Advance): ₹${d._computed.codAdvance}
Rest on Delivery: ₹${d._computed.codRestOnDelivery}

📏 Distance: ${d.distance} km
⏳ COD Order ETA: ${codEta}
📅 Estimated Delivery: ${estCodWindow}`;
}

/* Abandoned-cart: detailed message to customer */
function buildAbandonedCartCustomerMsg(d){
  d._computed = d._computed || {};
  const paymentMethod = 'wa_qr';
  d._computed.prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const prepaidAmount = Math.max(0, Number(d.basePrice||0) - d._computed.prepaidDiscount);
  const codInfo = computeCodAmountsForProduct(d);
  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta,2,3) : d.eta;
  const estWindow = d.eta && d.eta !== "N/A" ? estimatedWindowFromEta(d.eta) : "";

  return `🌟 GamesPlanet

🙏 Hello ${d.name} ji,

📝 Incomplete Order Details: 
– Order ID: ${d.orderId}
– Product: ${d.detectedProduct} (${d.variant})
– Base Price: ₹${d.basePrice}
📍 City: ${d.city}
📏 Distance: ${d.distance} km

💰 Prepaid Offer: ₹${d.basePrice} – ₹${d._computed.prepaidDiscount} discount = ₹${prepaidAmount}
🚚 Estimated Delivery (Prepaid): ${d.eta} — ${estWindow}

💵 COD: ₹${codInfo.codBase} + COD Charges: ₹${codInfo.codCharges}
➡ COD Advance: ₹${codInfo.advance}
➡ Remaining on Delivery: ₹${codInfo.rest}
🚚 Estimated Delivery (COD): ${codEta}

👉 Complete payment soon to confirm your order.

💚 Team GamesPlanet`;
}

/* Quick-buy exact text for sales link (lowercase, exact format) */
function buildQuickBuyMsg(d){
  const paymentMethod = 'wa_qr';
  const prepaidDiscount = computePrepaidDiscount(d, paymentMethod);
  const finalPrepaidAmount = Math.max(0, Number(d.basePrice||0) - prepaidDiscount);
  const productPart = (d.detectedProduct||'product').toString().trim().toLowerCase();
  const variantPart = (d.variant||'').toString().trim().toLowerCase();
  const variantText = variantPart ? (' ' + variantPart) : '';
  const amountText = String(Math.round(finalPrepaidAmount));
  return `i want to buy ${productPart}${variantText} with discount on full pay ${amountText} please share qr code`;
}

/* -------------------- Actions / Senders -------------------- */
function convert(){
  const d = parseInput();
  const prepaid = buildPrepaidMessage(d);
  const cod = buildCodMessage(d);
  document.getElementById('output').textContent = prepaid + "\n\n" + cod;
}

/* Safe senders to customer (normalize number to 91XXXXXXXXXX) */
function sendPrepaidToCustomer(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  const raw = getCustomerMobile();
  if(!raw){ alert('Customer mobile not found in input. Include Mobile: 9876543210 or +91 9876543210.'); return; }
  const to = raw.startsWith('91') ? raw : ('91' + raw);
  waOpen(to, msg);
}
function sendPrepaidToOwn(){ const d = parseInput(); waOpen(SALES_NUMBER, buildPrepaidMessage(d)); }

function sendCodToCustomer(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  const raw = getCustomerMobile();
  if(!raw){ alert('Customer mobile not found in input.'); return; }
  const to = raw.startsWith('91') ? raw : ('91' + raw);
  waOpen(to, msg);
}
function sendCodToOwn(){ const d = parseInput(); waOpen(SALES_NUMBER, buildCodMessage(d)); }

function sendThanks(){
  const d = parseInput();
  const msg = `🌟 GamesPlanet
🙏 Hello ${d.name} ji, thank you for your order ${d.orderId}.
📦 Product: ${d.detectedProduct} (${d.variant})
📍 Pincode: ${d.pincode} | 📏 Distance: ${d.distance} km
⏳ Estimated Delivery: ${d.eta}
🚚 Your order will be shipped soon between 8PM–10PM.
🔗 Tracking will update on our website after dispatch.
🖼️ On request, we can send *parcel pic & tracking number* here on WhatsApp.
💚 Team GamesPlanet`;
  const raw = getCustomerMobile();
  if(!raw){ alert('Customer mobile not found.'); return; }
  const to = raw.startsWith('91') ? raw : ('91' + raw);
  waOpen(to, msg);
}

/* ------------------ Abandoned Cart (updated behaviour) ------------------
   1) Detailed message is sent to CUSTOMER (if found)
   2) Second message is also sent to CUSTOMER and contains a wa.me link pointing to SALES_NUMBER
      (clicking that link opens chat to sales with the prefilled quick-buy message)
------------------------------------------------------------------------- */
function sendAbandonedCart(){
  const d = parseInput();
  const custRaw = getCustomerMobile();
  const custMsg = buildAbandonedCartCustomerMsg(d);
  const quick = buildQuickBuyMsg(d);
  const salesLink = `https://wa.me/${SALES_NUMBER}?text=${encodeURIComponent(quick)}`;
  const secondMsg = `Fast checkout link: ${salesLink}\n\n(Click to open QR payment on WhatsApp)`;

  if(custRaw){
    const cust = custRaw.startsWith('91') ? custRaw : ('91' + custRaw);
    // 1) send detailed message
    waOpen(cust, custMsg);
    // 2) send second message containing clickable sales link (after a short delay to avoid single-popup issues)
    setTimeout(()=> waOpen(cust, secondMsg), 800);
    // preview both in output
    document.getElementById('output').textContent = custMsg + "\n\nQuick-checkout link (sent to customer): " + salesLink;
  } else {
    alert('Customer mobile not found — cannot send abandoned-cart to customer. Quick-link is shown for manual share.');
    document.getElementById('output').textContent = "Customer mobile not found.\nQuick-link: " + salesLink + "\n\nQuick-buy message: " + quick;
  }
}

/* Quick Buy direct to sales (for testing/manual) */
function quickBuyToSales(){
  const d = parseInput();
  const quick = buildQuickBuyMsg(d);
  waOpen(SALES_NUMBER, quick);
  document.getElementById('output').textContent = quick;
}
</script>
</body>
</html>
