<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GamesPlanet Final Order Converter (Full Product + Variant List)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 980px; margin: 0 auto; }
    textarea { width: 100%; height: 280px; font-size: 14px; }
    pre { background: #f6f7f9; padding: 12px; white-space: pre-wrap; font-size: 14px; border-radius: 8px; border: 1px solid #e6e6e6; }
    button { padding: 10px 14px; font-size: 14px; margin: 6px 6px 6px 0; cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background:#fff; }
    .row { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
    .hr { height:1px; background:#e6e6e6; margin:14px 0; }
  </style>
</head>
<body>

<h2>GamesPlanet Final Order Converter (Full Product + Variant List)</h2>

<textarea id="input" placeholder="Paste order details here"></textarea>

<div class="row">
  <button onclick="selectAll()">Select All</button>
  <button onclick="clearText()">Clear</button>
  <button onclick="convert()">Convert (Preview Both)</button>
  <button onclick="copyAll()">Copy All</button>
</div>

<div class="row">
  <button onclick="sendPrepaidToCustomer()">Send Prepaid to Customer</button>
  <button onclick="sendPrepaidToOwn()">Send Prepaid to Own</button>
  <button onclick="sendCodToCustomer()">Send COD to Customer</button>
  <button onclick="sendCodToOwn()">Send COD to Own</button>
</div>

<div class="row">
  <button onclick="sendThanks()">Send Thanks</button>
  <button onclick="sendAbandonedCart()">Send Abandoned Cart</button>
</div>

<div class="hr"></div>
<pre id="output"></pre>

<script>
// ---------- Load pincode data ----------
let pincodeLatLng = {};
fetch('pincode_data.json')
  .then(r => r.json())
  .then(d => { pincodeLatLng = d; })
  .catch(e => console.log("Error loading pincode data:", e));

// ---------- Product & Variant lists ----------
const products = ["Super Mini U Box MD 16bit Sega ","aoko game stick","Aoko Game Stick","AOKO GAME STICK","aoko game stick v1","Aoko Game Stick V1","AOKO GAME STICK V1","black hawk","Black Hawk","BLACK HAWK","black hawk v1","Black Hawk V1","BLACK HAWK V1","fmcb","FMCB","FMCB","fmcb + usb","FMCB + USB","FMCB + USB","fmcb + usb optional","FMCB + USB Optional","FMCB + USB OPTIONAL","fmcb + usb top","FMCB + USB Top","FMCB + USB TOP","gamestick lite","Gamestick Lite","GAMESTICK LITE","gamestick pro","Gamestick Pro","GAMESTICK PRO","game stick gd10","Game Stick GD10","GAME STICK GD10","gamestick blaster","Gamestick Blaster","GAMESTICK BLASTER","game box g10","Game Box G10","GAME BOX G10","g10","G10","G10","g10v3","G10V3","G10V3","g11 pro","G11 Pro","G11 PRO","g11 pro special edition","G11 Pro Special Edition","G11 PRO SPECIAL EDITION","g11 pro ultimate edition","G11 Pro Ultimate Edition","G11 PRO ULTIMATE EDITION","gd10","GD10","GD10","gd30","GD30","GD30","gd35","GD35","GD35","gs5","GS5","GS5","k8","K8","K8","m15 pro","M15 Pro","M15 PRO","m22","M22","M22","m33","M33","M33","m44","M44","M44","m55","M55","M55","m66","M66","M66","m77","M77","M77","m88","M88","M88","m99","M99","M99","m222","M222","M222","m333","M333","M333","m444","M444","M444","m555","M555","M555","m666","M666","M666","m777","M777","M777","m888","M888","M888","m999","M999","M999","m1000","M1000","M1000","nintendo switch","Nintendo Switch","NINTENDO SWITCH","nintendo switch oled","Nintendo Switch OLED","NINTENDO SWITCH OLED","nintendo wii","Nintendo Wii","NINTENDO WII","nintendo wii u","Nintendo Wii U","NINTENDO WII U","nintendo ds","Nintendo DS","NINTENDO DS","nintendo 3ds","Nintendo 3DS","NINTENDO 3DS","ps1","PS1","PS1","ps2 slim","PS2 Slim","PS2 SLIM","ps3 slim","PS3 Slim","PS3 SLIM","ps3 super slim","PS3 Super Slim","PS3 SUPER SLIM","ps4 fat","PS4 Fat","PS4 FAT","ps4 pro","PS4 Pro","PS4 PRO","ps4 slim","PS4 Slim","PS4 SLIM","xbox 360","XBOX 360","XBOX 360","xbox one","XBOX One","XBOX ONE","xbox series s","XBOX Series S","XBOX SERIES S","xbox series x","XBOX Series X","XBOX SERIES X","pandora mini","Pandora Mini","PANDORA MINI","pandora pro","Pandora Pro","PANDORA PRO","sega mini u box","Sega Mini U Box","SEGA MINI U BOX","sega 16bit mini u box","Sega 16bit Mini U Box","SEGA 16BIT MINI U BOX","sup x7m","Sup X7M","SUP X7M","r35s","R35S","R35S","r36s","R36S","R36S","usb","USB","USB","sd card","SD Card","SD CARD"];
const variants = ["64gb","128gb","256gb","500gb","1tb","64gb optional","128gb optional","256gb optional","500gb optional","1tb optional","dual","single","sd card 64gb","sd card 128gb","sd card 256gb","64GB","128GB","256GB","500GB","1TB","64GB Optional","128GB Optional","256GB Optional","500GB Optional","1TB Optional","Dual","Single","SD CARD 64GB","SD CARD 128GB","SD CARD 256GB","64GB OPTIONAL","128GB OPTIONAL","256GB OPTIONAL","500GB OPTIONAL","1TB OPTIONAL","DUAL","SINGLE"];

// ---------- Helpers ----------
function selectAll(){ const t = document.getElementById("input"); t.focus(); t.select(); }
function clearText(){ document.getElementById("input").value=""; document.getElementById("output").textContent=""; }
function copyAll(){ navigator.clipboard.writeText(document.getElementById("output").textContent).then(()=>alert("Output copied!")); }
function encodeForWA(text){ return encodeURIComponent(text); }
function waOpen(number, msg){ window.open(`https://wa.me/${number}?text=${encodeForWA(msg)}`, "_blank"); }
function getOwnNumber(){ return "917983624797"; }

// Prefill URL builder (uses parsed values, not DOM inputs)
function buildPrefillUrl(d) {
  // NOTE: the uploaded file name contains a space and (1) â€” keep it exactly as is.
  const prefillPath = "./order-prefill%20(1).html";
  const qs = `?product=${encodeURIComponent(d.detectedProduct || "")}` +
             `&variant=${encodeURIComponent(d.variant || "")}` +
             `&base=${encodeURIComponent(d.basePrice || "")}`;
  return prefillPath + qs;
}

// Prefer explicit mobile line; fallback to any 10-digit match
function getCustomerMobile() {
  const raw = document.getElementById("input").value;
  const line = raw.match(/(?:mobile|phone)\s*[:\n]\s*([+]?91[-\s]?\d{10}|\d{10})/i)?.[1];
  if (line) return line.replace(/\D/g,"").replace(/^0+/, "");
  const any = raw.match(/(?:\+?91[-\s]?)?\d{10}/);
  return any ? any[0].replace(/\D/g,"").replace(/^0+/, "") : "";
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  // fix typo: Math not math
}
</script>
<script>
// Continue script after fixing the small typo above
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function estimateDeliveryByDistance(distance) {
  const d = Number(distance);
  if (d <= 30) return "1 day";
  else if (d <= 60) return "1-2 days";
  else if (d <= 100) return "2-3 days";
  else if (d <= 200) return "3-4 days";
  else if (d <= 500) return "4-5 days";
  else if (d <= 1000) return "4-6 days";
  else if (d <= 1500) return "5â€“7 days";
  else if (d <= 2000) return "6â€“8 days";
  else if (d <= 3000) return "6â€“10 days";
  else return "8â€“12 days (sometimes up to 15 days)";
}

// ETA helpers
function parseEtaRange(etaStr){
  if(!etaStr || etaStr==="N/A") return null;
  const nums = (etaStr.match(/\d+/g)||[]).map(n=>parseInt(n,10));
  if(nums.length === 1) return {min: nums[0], max: nums[0]};
  if(nums.length >= 2) return {min: nums[0], max: nums[1]};
  return null;
}
function bumpEtaRangeString(etaStr, addMin=2, addMax=3){
  const r = parseEtaRange(etaStr);
  if(!r) return etaStr;
  const min = r.min + addMin;
  const max = r.max + addMax;
  return (min===max) ? `${min} days` : `${min}-${max} days`;
}
function todayStrOffset(days){
  const d = new Date();
  d.setDate(d.getDate()+days);
  return d.toLocaleDateString('en-IN', {day:'2-digit', month:'short'});
}
function estimatedWindowFromEta(etaStr){
  const r = parseEtaRange(etaStr);
  if(!r) return etaStr || "";
  const start = todayStrOffset(r.min);
  const end   = todayStrOffset(r.max);
  return (r.min===r.max) ? `${start}` : `${start} to ${end}`;
}

// ---------- Robust Parser ----------
// ---------- Robust Parser (handles your sample exactly) ----------
function parseInput(){
  const raw = document.getElementById("input").value;
  const input = raw.toLowerCase();

  // Order ID: "#12345" OR first number-like token at the top line
  let orderId = (raw.match(/#\s*\d{5,}/)?.[0] || "").replace(/\s+/g,'');
  if(!orderId){
    const firstLine = (raw.split('\n').map(s=>s.trim()).find(s=>s) || "");
    const m = firstLine.match(/\d{6,}/);
    if(m) orderId = "#" + m[0];
  }
  if(!orderId) orderId = "Not found";

  // Name / Mobile / Alt Mobile / Email
  const name = (raw.match(/name\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\n([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\nMobile/i)?.[1] || "Customer").trim();
  const mobile = (raw.match(/mobile\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/\+?91[-\s]?\d{10}/)?.[0] || "").trim();
  const altMobile = (raw.match(/alternate\s*mobile(?:\s*number)?\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/Alt(?:ernate)?\s*Mobile\s*\n?([^\n]+)/i)?.[1] || "").trim();
  const email = (raw.match(/email\s*[:\n]\s*([^\n]+)/i)?.[1] || raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)?.[0] || "").trim();

  // Address (entire line after â€œShipping addressâ€)
  const address = (raw.match(/shipping\s*address\s*[:\n]\s*([\s\S]*?)(?:\n(?:Payments|Payment|Additional|Customer|Mobile|Email|$))/i)?.[1] ||
                  raw.match(/address\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim().replace(/\s+/g,' ').trim();

  // Landmark: try â€œNear â€¦ / Opp / Behind / Beside â€¦â€ if explicit Landmark: not present
  // Landmark: try to pick â€œNear ...â€, â€œOpp/Behind/Beside ...â€, or explicit Landmark:
  let landmark = (raw.match(/landmark\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim();
  if(!landmark){
    const near = address.match(/\b(?:near|opp(?:osite)?|behind|beside)\b[^,;|]+/i);
    if(near) landmark = near[0].trim();
  }

  // Post office: if present explicitly
  const postOffice = (raw.match(/post\s*office\s*[:\n]\s*([^\n]+)/i)?.[1] || "").trim();

  // Pincode (6 digits)
  const pincode = (raw.match(/\b\d{6}\b/)?.[0] || "").trim();

  // Price block: handle â€œ1x â‚¹1,899â€, Subtotal, Coupon discount (DISC5) -â‚¹5, Total PAID â‚¹1,894
  const basePrice = ((raw.match(/1x\s*â‚¹?\s*([\d,]+)/i)?.[1] || raw.match(/base\s*price\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();

  let discount = "0";
  const couponLine = raw.match(/coupon\s*discount.*?(-â‚¹\s*[\d,]+)/i);
  if (couponLine) discount = couponLine[1].replace(/[^\d]/g,'');
  else {
    const d2 = raw.match(/discount\s*applied\s*[:â‚¹\s-]*([\d,]+)/i);
    if (d2) discount = d2[1].replace(/,/g,'');
  }

  const amountPaid = ((raw.match(/total\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/\bpaid\b\s*[:â‚¹\s]*([\d,]+)/i)?.[1] ||
                       raw.match(/amount\s*paid\s*[:â‚¹\s]*([\d,]+)/i)?.[1] || "0").replace(/,/g,"")).trim();

  // Product: prefer â€œ1 item\n<name>â€
  // Product: prefer an explicit product line; else any known product token from big list
  let detectedProduct = "Unknown Product";
  // Try the â€œ1 item\n<name>â€ style
  const afterItem = raw.split(/1\s*item/i)[1]?.trim().split('\n')[0]?.trim();
  if(afterItem && afterItem.length>2) detectedProduct = afterItem.toUpperCase();
  if(detectedProduct==="Unknown PRODUCT" || detectedProduct==="Unknown Product"){
  // If still unknown, scan list
  if(detectedProduct==="Unknown Product"){
    const lower = input;
    products.sort((a,b)=>b.length-a.length);
    for (let p of products){ if (lower.includes(p.toLowerCase())) { detectedProduct = p.toUpperCase(); break; } }
  }

  // Variant: from product line or generic keys
  let variant = "";
  const vKey = raw.match(/(?:size|storage|variant|verient)\s*[:\s]*([^\n]+)/i);
  if(vKey) variant = vKey[1].trim().toUpperCase();
  else {
    const vInName = detectedProduct.match(/\b(64GB|128GB|256GB|500GB|1TB)\b/i);
    if(vInName) variant = vInName[1].toUpperCase();
  }

  // Geo / ETA
  let city = "Unknown", state = "Unknown", distance = "N/A", eta = "N/A";
  if (pincode && pincodeLatLng[pincode]) {
    const dest = pincodeLatLng[pincode];
    city = dest.city || "Unknown";
    state = dest.state || "Unknown";
    distance = haversine(28.8,79.0,dest.lat,dest.lng).toFixed(0); // Rampur approx
    eta = estimateDeliveryByDistance(distance);
  }

  return {
    orderId, name, mobile, altMobile, email,
    address, landmark, postOffice, pincode,
    basePrice, discount, amountPaid,
    detectedProduct, variant,
    city, state, distance, eta
  };
}

// ---------- Message builders (exact style + Prefill link) ----------
// ---------- Message builders (exact style) ----------
function buildPrepaidMessage(d){
  const estWindow = d.eta && d.eta!=="N/A" ? estimatedWindowFromEta(d.eta) : "";
  const prefill = buildPrefillUrl(d);
  return `ğŸŸ¢ Prepaid Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${d.basePrice}
Discount Applied: â‚¹${d.discount}
Amount Paid: â‚¹${d.amountPaid}

ğŸ“ Distance: ${d.distance} km
â³ Prepaid Order ETA: ${d.eta}
ğŸ“… Estimated Delivery: ${estWindow}

ğŸ§¾ Prefill link: ${prefill}`;
ğŸ“… Estimated Delivery: ${estWindow}`;
}

// COD rules (as per your instruction):
// - advance = max(â‚¹500, 10% of base); ignore any input paid for COD
// Enforce COD rules you asked:
// - advance = max(â‚¹500, 10% of base)  (ignore any input amountPaid for COD)
// - cod charges = 0
// - discount shows 0
// - ETA bumped +2â€“3 days
function buildCodMessage(d){
  const base = parseInt(d.basePrice||"0",10);
  const advance = Math.max(500, Math.round(base * 0.10));
  const rest = Math.max(base - advance, 0);

  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;
  const estCodWindow = codEta && codEta!=="N/A" ? estimatedWindowFromEta(codEta) : "";
  const prefill = buildPrefillUrl(d);

  return `ğŸ”´ COD Order on WhatsApp

Order ID: ${d.orderId}
Name: ${d.name}
Mobile: ${d.mobile}
Alt Mobile: ${d.altMobile}
Email: ${d.email}
Address: ${d.address}
Landmark: ${d.landmark}
Pincode: ${d.pincode}
State: ${d.state}
District/City: ${d.city}
Post office: ${d.postOffice}
Product: ${d.detectedProduct}
Variant: ${d.variant}
Base Price: â‚¹${base}
Discount Applied: â‚¹0
Amount Paid: â‚¹${advance}
Rest on Delivery: â‚¹${rest}

ğŸ“ Distance: ${d.distance} km
â³ COD Order ETA: ${codEta}
ğŸ“… Estimated Delivery: ${estCodWindow}

ğŸ§¾ Prefill link: ${prefill}`;
ğŸ“… Estimated Delivery: ${estCodWindow}`;
}

// ---------- Preview both ----------
function convert(){
  const d = parseInput();
  const prepaid = buildPrepaidMessage(d);
  const cod = buildCodMessage(d);
  document.getElementById("output").textContent = prepaid + "\n\n" + cod;
}

// ---------- Senders ----------
function getWaNumberFormatted(num){
  // Ensure it starts with 91
  const n = (num||"").replace(/\D/g,"");
  return n.startsWith("91") ? n : "91" + n;
}
function sendPrepaidToCustomer(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  const mobile = getCustomerMobile();
  if(mobile) waOpen(getWaNumberFormatted(mobile), msg);
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendPrepaidToOwn(){
  const d = parseInput();
  const msg = buildPrepaidMessage(d);
  waOpen(getOwnNumber(), msg);
}
function sendCodToCustomer(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  const mobile = getCustomerMobile();
  if(mobile) waOpen(getWaNumberFormatted(mobile), msg);
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendCodToOwn(){
  const d = parseInput();
  const msg = buildCodMessage(d);
  waOpen(getOwnNumber(), msg);
}

// ---------- Optional extras ----------
function sendThanks() {
  const d = parseInput();
  const msg =
`ğŸŒŸ GamesPlanet
ğŸ™ Hello ${d.name} ji, thank you for your order ${d.orderId}.
ğŸ“¦ Product: ${d.detectedProduct} (${d.variant})
ğŸ“ Pincode: ${d.pincode} | ğŸ“ Distance: ${d.distance} km
â³ Estimated Delivery: ${d.eta}
ğŸšš Your order will be shipped soon between 8PMâ€“10PM.
ğŸ”— Tracking will update on our website after dispatch.
ğŸ–¼ï¸ On request, we can send *parcel pic & tracking number* here on WhatsApp.
ğŸ’š Team GamesPlanet`;
  const mobile = getCustomerMobile();
  if(mobile) waOpen(getWaNumberFormatted(mobile), msg);
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
function sendAbandonedCart() {
  const d = parseInput();
  const base = parseInt(d.basePrice || "0",10);
  const discount = parseInt(d.discount || "0",10);
  const prepaidAmount = Math.max(base - discount, 0);
  const codAdvance = Math.max(500, Math.round(base * 0.10));
  const codRemaining = Math.max(base - codAdvance, 0);
  const codEta = d.eta && d.eta !== "N/A" ? bumpEtaRangeString(d.eta, 2, 3) : d.eta;

  const msg =
`ğŸŒŸ GamesPlanet

ğŸ™ Hello ${d.name} ji,

ğŸ“ Incomplete Order Details:
â€“ Order ID: ${d.orderId}
â€“ Product: ${d.detectedProduct} (${d.variant})
â€“ Base Price: â‚¹${base}
ğŸ“ City: ${d.city}
ğŸ“ Distance: ${d.distance} km

ğŸ’° Prepaid Offer: â‚¹${base} â€“ â‚¹${discount} discount = â‚¹${prepaidAmount}
ğŸšš Estimated Delivery:
â€“ Prepaid: ${d.eta}

ğŸ’µ COD: â‚¹${base} (no discount)
â¡ COD Advance: â‚¹${codAdvance}
â¡ Remaining on Delivery: â‚¹${codRemaining}
ğŸšš Estimated Delivery:
â€“ COD: ${codEta}

ğŸ‘‰ Complete payment soon to confirm your order.
ğŸ’š Team GamesPlanet`;
  const mobile = getCustomerMobile();
  if(mobile) waOpen(getWaNumberFormatted(mobile), msg);
  if(mobile) waOpen(mobile.startsWith("91") ? mobile : "91"+mobile, msg);
  else alert("Customer mobile number not found in input.");
}
</script>

</body>
</html>
